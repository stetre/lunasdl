<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Stefano Trettel">
<title>LunaSDL Reference Manual</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7b2d00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
table thead, table tfoot { background: -webkit-linear-gradient(top, #add386, #90b66a); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: white; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

.keyseq { color: #333333; }

kbd { display: inline-block; color: black; font-size: 0.75em; line-height: 1.4; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: #7b2d00; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #e15200; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #333333; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #333333; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: #7b2d00; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Arial, sans-serif; list-style-type: none; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #003b6b; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: white; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7b2d00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: #7b2d00; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #e15200; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px dashed #666666; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 1.25em 1.5625em 1.125em 1.5625em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1.25em 1.5625em 1.125em 1.5625em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 0.75em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #333333; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #003b6b; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #e15200; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 0.75em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #333333; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.05em; color: #e15200; }

.quoteblock.abstract { margin: 0 0 0.75em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.spread { width: 100%; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #d8d8ce; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: white; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1em; font-size: 0.85em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { width: 1em; position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .75em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
span.footnote a:active, span.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #004176; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #dddddd; }

.sect1 { padding-bottom: 0; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #ffffff; }
.listingblock .pygments .tok-c { color: #aaaaaa; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { color: #FF0000; background-color: #FFAAAA } /* Error */
.listingblock .pygments .tok-k { color: #0000aa } /* Keyword */
.listingblock .pygments .tok-cm { color: #aaaaaa; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #4c8317 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #aaaaaa; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #0000aa; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #aa0000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #aa0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00aa00 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #555555 } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #aa0000 } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #0000aa } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #0000aa } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #0000aa } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #0000aa } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #0000aa } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #00aaaa } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #009999 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #aa5500 } /* Literal.String */
.listingblock .pygments .tok-na { color: #1e90ff } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #00aaaa } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #00aa00; text-decoration: underline } /* Name.Class */
.listingblock .pygments .tok-no { color: #aa0000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #888888 } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #880000; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-nf { color: #00aa00 } /* Name.Function */
.listingblock .pygments .tok-nn { color: #00aaaa; text-decoration: underline } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #1e90ff; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #aa0000 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #0000aa } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #009999 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #009999 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #009999 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #009999 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #009999 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #aa5500 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #aa5500 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #aa5500 } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #aa5500 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #aa5500 } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #aa5500 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #aa5500 } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #aa5500 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #009999 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #aa5500 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #0000aa } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #00aaaa } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #aa0000 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #aa0000 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #aa0000 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #009999 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>LunaSDL Reference Manual</h1>
<div class="details">
<span id="author" class="author">Stefano Trettel</span><br>
<span id="revnumber">version 0.1,</span>
<span id="revdate">2015-02-06</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_what_is_lunasdl">What is LunaSDL</a></li>
<li><a href="#_getting_and_installing">Getting and installing</a></li>
<li><a href="#_module_organization">Module organization</a></li>
<li><a href="#_license">License</a></li>
</ul>
</li>
<li><a href="#_overview">Overview</a>
<ul class="sectlevel2">
<li><a href="#_lunasdl_applications">LunaSDL applications</a></li>
<li><a href="#_communication">Communication</a></li>
<li><a href="#_reactivity_and_concurrency">Reactivity and concurrency</a></li>
<li><a href="#_agents_hierarchy">Agents hierarchy</a></li>
<li><a href="#_agents_identification">Agents identification</a></li>
</ul>
</li>
<li><a href="#_the_main_script">The main script</a></li>
<li><a href="#_agent_scripts">Agent scripts</a>
<ul class="sectlevel2">
<li><a href="#_state_machine_functions">State machine functions</a></li>
<li><a href="#_transitions">Transitions</a></li>
<li><a href="#_the_start_transition">The start transition</a></li>
<li><a href="#_receiving_input_signals">Receiving input signals</a></li>
<li><a href="#_stopping_an_agent">Stopping an agent</a></li>
</ul>
</li>
<li><a href="#_creating_agents">Creating agents</a>
<ul class="sectlevel2">
<li><a href="#_system_return_values">System return values</a></li>
<li><a href="#_finding_agent_scripts">Finding agent scripts</a></li>
</ul>
</li>
<li><a href="#_signals">Signals</a>
<ul class="sectlevel2">
<li><a href="#_format_of_signals">Format of signals</a></li>
<li><a href="#_sending_signals">Sending signals</a></li>
<li><a href="#_time_triggered_signals">Time-triggered signals</a></li>
<li><a href="#_saving_and_re_scheduling_signals">Saving and re-scheduling signals</a></li>
</ul>
</li>
<li><a href="#_timers">Timers</a></li>
<li><a href="#_system_time">System time</a></li>
<li><a href="#_agent_information">Agent information</a></li>
<li><a href="#_procedures">Procedures</a></li>
<li><a href="#_remote_functions">Remote functions</a></li>
<li><a href="#_the_event_loop">The event loop</a>
<ul class="sectlevel2">
<li><a href="#_registering_file_descriptors">Registering file descriptors</a></li>
<li><a href="#_sockets">Sockets</a></li>
<li><a href="#_event_loop_details">Event loop details</a></li>
</ul>
</li>
<li><a href="#_logs_and_traces">Logs and traces</a>
<ul class="sectlevel2">
<li><a href="#_logs">Logs</a></li>
<li><a href="#_traces">Traces</a></li>
</ul>
</li>
<li><a href="#_optional_configurations">Optional configurations</a></li>
<li><a href="#_examples">Examples</a>
<ul class="sectlevel2">
<li><a href="#_hello_world">Hello World</a></li>
<li><a href="#_ping_pong">Ping Pong</a></li>
<li><a href="#_ping_pong_over_udp">Ping Pong over UDP</a></li>
<li><a href="#_web_pages_download">Web pages download</a></li>
<li><a href="#_database_agent">Database agent</a></li>
<li><a href="#_priority_signals">Priority signals</a></li>
<li><a href="#_procedure_call">Procedure call</a></li>
</ul>
</li>
<li><a href="#_special_variables">Special variables</a></li>
<li><a href="#_summary_of_lunasdl_functions">Summary of LunaSDL functions</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<a class="image" href="http://www.lua.org"><img src="powered-by-lua.gif" alt="Lua logo"></a>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This manual describes the functions provided by LunaSDL.
It is assumed that the reader is familiar with the
<a href="http://www.lua.org">Lua programming language</a>. Familiarity with SDL may be of help,
but is not essential to read this document.<span class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</span>
<span class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</span></p>
</div>
<div class="sect2">
<h3 id="_what_is_lunasdl">What is LunaSDL</h3>
<div class="paragraph">
<p>LunaSDL is a <strong>Lua module for event-driven concurrent programming</strong>, whose design follows the
concurrency model of the
<strong><a href="http://en.wikipedia.org/wiki/Specification_and_Description_Language">ITU-T Specification and
Description Language (SDL)</a></strong>.</p>
</div>
<div class="paragraph">
<p>LunaSDL turns Lua into an SDL dialect by extending it with the basic constructs for the
implementation of SDL systems, which are systems composed of concurrent, reactive and
intercommunicating entities referred to as <strong>agents</strong>.<span class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</span></p>
</div>
<div class="paragraph">
<p>What LunaSDL is not. It is not an editor or a validator of SDL specifications, and it is
not a code generator from SDL specifications (it may, however, be used as target language
for tools that do such things). Moreover, LunaSDL is not intended for parallel multithreading
and multi-core programming, nor for hard real-time applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_and_installing">Getting and installing</h3>
<div class="paragraph">
<p>The <strong>official repository</strong> of LunaSDL is on GitHub at the following link:
<strong><a href="https://github.com/stetre/lunasdl" class="bare">https://github.com/stetre/lunasdl</a></strong> .</p>
</div>
<div class="paragraph">
<p>LunaSDL requires <strong><a href="http://www.lua.org">Lua</a></strong> version 5.2 or greater,
and <strong><a href="https://github.com/diegonehab/luasocket">LuaSocket</a></strong>.</p>
</div>
<div class="paragraph">
<p>Since it is written in plain Lua, no compiling is needed.</p>
</div>
<div class="paragraph">
<p>LunaSDL has been tested on Linux (Fedora 21) and on OpenBSD (5.6). It may run
on any other OS supported by Lua and LuaSocket, but this has not been tested.</p>
</div>
<div class="paragraph">
<p>To install LunaSDL, download the
<a href="https://github.com/stetre/lunasdl/releases">latest release</a> and extract it somewhere
on your system.</p>
</div>
<div class="paragraph">
<p>To use LunaSDL, make sure that the base directory containing the <code>lunasdl.lua</code> script
is in Lua&#8217;s
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-package.path"><em>package.path</em></a> (for this
purpose, there is an example <code>configure</code> shell script in the base directory.)</p>
</div>
<div class="paragraph">
<p>For example, on a GNU/Linux system, you may do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"># ... download lunasdl-0.1.tar.gz ...
[ ]$ tar -zxpvf lunasdl-0.1.tar.gz
[ ]$ cd lunasdl-0.1
[lunasdl-0.1]$ . configure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, using wget:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell">[ ]$ wget https://github.com/stetre/lunasdl/archive/v0.1.tar.gz
[ ]$ tar -zxpvf v0.1.tar.gz
[ ]$ cd lunasdl-0.1
[lunasdl-0.1]$ . configure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some basic examples can be found in the <code>examples/</code> directory and are described
in the <a href="#_examples">Examples</a> section of this manual.</p>
</div>
<div class="paragraph">
<p>Common to all examples, and to LunaSDL applications in general, is the need to properly
set the <code>LUNASDL_PATH</code> environment variable so that LunaSDL can find the scripts used by
the application. For more details, see the
<a href="#_finding_agent_scripts">Finding agent scripts</a> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_module_organization">Module organization</h3>
<div class="paragraph">
<p>The LunaSDL module is loaded using Lua&#8217;s
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-require"><em>require</em></a> function and
returns a table containing the functions it provides
(as usual with Lua modules). This manual assumes that such
table is named <strong><em>sdl</em></strong>, i.e. that it is loaded with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>but nothing forbids the use of a different name.</p>
</div>
<div class="paragraph">
<p>As explained later in the manual, LunaSDL creates multiple Lua environments, one per
SDL agent. All these environments share the same <strong><em>sdl</em></strong> table. In each agent&#8217;s environment,
LunaSDL defines also some special global variables that it uses to share information
with the agent, and some other special variables for internal use (mostly packed in another
table named <strong><em>sdl_</em></strong>). To avoid conflicts with user-defined identifiers, a minimal
naming convention is used. See the <a href="#_special_variables">Special variables</a> section
for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_license">License</h3>
<div class="paragraph">
<p>LunaSDL is released under the <strong>MIT/X11 license</strong> (same as
<a href="http://www.lua.org/license.html">Lua</a>, and with the same only requirement to give proper
credits to the original author).
The copyright notice is in the LICENSE file in the base directory
of the <a href="https://github.com/stetre/lunasdl">official repository</a> on GitHub.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">Overview</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_lunasdl_applications">LunaSDL applications</h3>
<div class="paragraph">
<p>A <strong>LunaSDL application</strong> is any application written in Lua that relies on LunaSDL to
implement a system of concurrent, reactive and intercommunicating entities.
In the SDL jargon, and thus in LunaSDL, such entities are called <strong>agents</strong>.
You can think of them as of cooperative threads of execution, akin to Lua&#8217;s
native <a href="http://www.lua.org/manual/5.3/manual.html#2.6">coroutines</a>.</p>
</div>
<div class="paragraph">
<p>In its most natural form, a LunaSDL application is composed of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <a href="#_the_main_script"><strong>main script</strong></a>, that loads and configures the LunaSDL module,
creates the first agent, and then enters an event loop, and</p>
</li>
<li>
<p>one or more <a href="#_agent_scripts"><strong>agent scripts</strong></a>, each of them defining the behavior
of an agent (more precisely, of a <em>type</em> of agent).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Agents are created with the functions of the <a href="#_creating_agents"><em>sdl.create family</em></a>,
and each of them has its script executed in a dedicated
<a href="http://www.lua.org/manual/5.3/manual.html#2.2">Lua environment</a>, which provides
separation of its namespace from those of other agents running in the same application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_communication">Communication</h3>
<div class="paragraph">
<p>Agents communicate mainly by sending <a href="#_signals"><strong>signals</strong></a> to each other, and may create
and set <a href="#_timers"><strong>timers</strong></a>, whose expiries are also notified to agents by means of signals.</p>
</div>
<div class="paragraph">
<p>Agents may also communicate with the outside world with respect to the system (i.e. the
<em>environment</em>
<span class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</span>)
by means of <a href="#_the_event_loop"><strong>file descriptor objects</strong></a> like, for example, sockets.
Multiple file descriptor objects can be used concurrently.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reactivity_and_concurrency">Reactivity and concurrency</h3>
<div class="paragraph">
<p>Agent scripts define the behavior of agents in terms of state machines, whose transitions
are triggered by events represented by the reception of signals.</p>
</div>
<div id="eventloop" class="paragraph">
<p>The interleaved execution of agents is controlled by an
<a href="#_the_event_loop"><strong>event loop</strong></a>
that dispatches signals one at a time.</p>
</div>
<div class="paragraph">
<p>Every time the event loop dispatches a signal, the agent which is the destination of the
signal becomes the <strong>current agent</strong>, executes some code depending on its state and on the
signal, and then returns to the event loop (the model of concurrency is <em>cooperative</em>).
The event loop then dispatches the next signal, if any is scheduled, otherwise it waits
for stimuli, which may be the expiry of timers or file descriptors that have become ready
for read or write operations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_agents_hierarchy">Agents hierarchy</h3>
<div class="paragraph">
<p>With the exception of the first agent, which is created at startup, every agent in a LunaSDL
application is created by another already existing agent, and is linked to it in a <em>child-parent</em>
relationship. Thus, agents are naturally organized in a hierarchical tree, whose root is
the first agent and is called the <strong>system agent</strong>.</p>
</div>
<div class="paragraph">
<p>There are three <em>kinds</em> of agents: <strong>system</strong>, <strong>block</strong> and <strong>process</strong>.
Only one agent (the first created) is of the kind <em>system</em>, while the others may be of the
kinds <em>block</em> or <em>process</em>, the difference between the two being that a <em>block</em> represents a
container of agents (with an associated domain name) while a <em>process</em> does not.</p>
</div>
<div class="paragraph">
<p>Every SDL agent is also directly contained in an SDL agent of the kind <em>block</em> or
in the <em>system agent</em> (which is also a block, although a special one).
The block an agent is contained in is its parent, if this is a block, or the same block
the parent is contained in, otherwise.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Conventionally, the system agent&#8217;s parent is itself, and it is contained in itself.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_agents_identification">Agents identification</h3>
<div id="pid" class="paragraph">
<p>Agents are identified by their <strong>process identifier (pid)</strong>, which is unique within a
LunaSDL application. The pid is an integer value automatically assigned to an agent at
its creation, and is used as address when sending signals. The pid value <em>0 (zero)</em>  always
identifies the system agent.</p>
</div>
<div id="agent_name" class="paragraph">
<p>Each agent is also assigned, by its parent, an <strong>agent name</strong> (a string) which is required
to be unique within the block the agent is contained in, but may be reused in different blocks.</p>
</div>
<div class="paragraph">
<p>The agent name may encode information such as the agent&#8217;s &#8216;type&#8217; and &#8216;instance&#8217; (but this
is up to the application designer) and provides a convenient way to identify agents in reusable
agent scripts without relying on the pid values being always the same from application to
application (which is generally not true, being pids dynamically assigned).</p>
</div>
<div class="paragraph">
<p>Functions are provided to <a href="#_agent_information">resolve agent names into pids</a> and viceversa.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_main_script">The main script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A typical main script of a LunaSDL application looks like in the example below.
The application is executed like any other regular Lua script, for example
using the <a href="http://www.lua.org/manual/5.3/manual.html#7">standalone Lua interpreter</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"> ~$ lua main.lua</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Main script example:</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"> <span class="tok-c1">-- main.lua</span>
 <span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>
 
 <span class="tok-c1">-- ... get arguments from command line or from elsewhere...</span>
 <span class="tok-c1">-- ... optionally configure LunaSDL ...</span>
 
 <span class="tok-c1">-- Open the system log file</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logopen</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">mylogfile.log&quot;</span><span class="tok-p">)</span>
 
 
 <span class="tok-c1">-- Create the system agent as defined by the agent script &quot;mysystem.lua&quot;,</span>
 <span class="tok-c1">-- give it the agent name &quot;System&quot;, and enter the event loop:</span>
 <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">System&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">mysystem&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The script loads the LunaSDL module, optionally <a href="#_optional_configurations">configures</a> it,
and then it <a href="#_creating_agents">creates</a> the first agent (i.e. the <em>system agent</em>), which in
turn may or may not create other agents, depending on the application.</p>
</div>
<div class="paragraph">
<p>The <a href="#sdl.createsystem"><em>sdl.createsystem</em></a> call, besides creating the system agent, enters
the event loop and returns only when the system stops.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_agent_scripts">Agent scripts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An agent script defines the behavior of an agent in terms of a state machine, whose
transitions are triggered by the arrival of input <a href="#_signals">signals</a>.
It may look like in the example shown below, in which the bottom part defines the
transitions of the state machine, associating Lua functions to combinations of states
and input signals names, and the top part implements those Lua functions.</p>
</div>
<div class="listingblock">
<div class="title">Agent script (incomplete) example:</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"> <span class="tok-c1">-- agent.lua</span>
 
 <span class="tok-kd">local</span> <span class="tok-n">T</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">timer</span><span class="tok-p">(</span><span class="tok-mi">30</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T_EXPIRED&quot;</span><span class="tok-p">)</span>
 <span class="tok-kd">local</span> <span class="tok-n">somevariable</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
 
 <span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">()</span>
   <span class="tok-c1">-- .. &#39;start transition&#39; here ..</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">)</span>
 <span class="tok-k">end</span>
 
 <span class="tok-k">function</span> <span class="tok-nf">Waiting_ConReq</span><span class="tok-p">()</span>
   <span class="tok-c1">-- ... transition: received CONREQ signal in Waiting state ...</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">CONACK&quot;</span> <span class="tok-p">},</span> <span class="tok-n">sender_</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Connecting&quot;</span><span class="tok-p">)</span>
 <span class="tok-k">end</span>
 
 <span class="tok-k">function</span> <span class="tok-nf">Connecting_TExpired</span><span class="tok-p">()</span>
   <span class="tok-c1">-- ... transition: received T_EXPIRED signal in Connecting state ...</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">FAILURE&quot;</span> <span class="tok-p">},</span> <span class="tok-n">parent_</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
 <span class="tok-k">end</span>
 
 <span class="tok-c1">-- ... cut ...</span>
 
 <span class="tok-c1">-- the state machine:</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Start</span><span class="tok-p">)</span> <span class="tok-c1">-- sets the &#39;start transition</span>
 <span class="tok-c1">--             state, input signal, transition function</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">CONREQ&quot;</span><span class="tok-p">,</span><span class="tok-n">Waiting_ConReq</span><span class="tok-p">)</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Connecting&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">CONCNF&quot;</span><span class="tok-p">,</span><span class="tok-n">Connecting_ConCnf</span><span class="tok-p">)</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Connecting&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T_EXPIRED&quot;</span><span class="tok-p">,</span><span class="tok-n">Connecting_TExpired</span><span class="tok-p">)</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Connected&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">DATA&quot;</span><span class="tok-p">,</span><span class="tok-n">Connected_Data</span><span class="tok-p">)</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Any&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span><span class="tok-p">,</span><span class="tok-n">Any_Stop</span><span class="tok-p">)</span>
 <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">default</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Any&quot;</span><span class="tok-p">)</span> <span class="tok-c1">-- the default state (&#39;asterisk state&#39;)</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_state_machine_functions">State machine functions</h3>
<div class="paragraph">
<p>In order to define state machines, LunaSDL provides the functions described hereafter.
More details can be found in the subsections that follow.</p>
</div>
<hr>
<div id="sdl.start" class="ulist">
<ul>
<li>
<p><strong>sdl.start</strong> ( <em>func</em> )<br>
<br>
Sets the function <em>func</em> as the agent&#8217;s <em>start transition</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.transition" class="ulist">
<ul>
<li>
<p><strong>sdl.transition</strong> ( <em>state</em>, <em>signame</em>, <em>func</em> )<br>
<br>
Sets the function <em>func</em> as the transition to be executed when a signal named <em>signame</em>
(a string) arrives with the agent being in the <em>state</em> state (also, a string).<br>
<a id="asterisktransition"></a><br>
The value &#8216;*&#8217; (asterisk) may be passed as argument for the <em>signame</em> parameter,
meaning <em>'any signal name for which an explicit transition has not been set for this state'</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.default" class="ulist">
<ul>
<li>
<p><strong>sdl.default</strong> ( <em>state</em> )<br>
<br>
Sets <em>state</em> (a string) as the agent&#8217;s default state. The default state is optional,
and can be used to define transitions for signals which are not catched
with <a href="#sdl.transition"><em>sdl.transition</em></a> in the state the agent is in when they arrive.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.nextstate" class="ulist">
<ul>
<li>
<p><strong>sdl.nextstate</strong> ( <em>state</em> )<br>
<br>
To be used within transitions, changes the current state of the agent to <em>state</em>.<br>
<br>
If the state actually changes, i.e. if the agent was not already in that state,
this function also re-schedules any input signal previously saved with <a href="#sdl.save"><em>sdl.save</em></a>.
Otherwise calling this function is superfluous but harmless.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.stop" class="ulist">
<ul>
<li>
<p><strong>sdl.stop</strong> ( [ <em>atstopfunc</em> ] )<br>
<br>
To be used within transitions, gracefully stops the agent&#8217;s state machine and determines
the termination of the agent itself.<br>
<br>
The optional <em>atstopfunc</em> argument (a function) is a finalizer to be called
when the agent actually terminates.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.kill" class="ulist">
<ul>
<li>
<p><strong>sdl.kill</strong> ( [ <em>pid</em> ] )<br>
<br>
To be used within transitions, ungracefully terminates the agent identified by <em>pid</em>
and all its descendants, without passing through the <em>stopping condition</em>.
The calling agent must be an ascendant of the agent to be killed, or the agent itself.
The <em>pid</em> argument defaults to <strong><em>self_</em></strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_transitions">Transitions</h3>
<div class="paragraph">
<p>A <strong>transition</strong> is a function implemented in the agent script, set by means of the above
functions as the code to be executed at the arrival of an input signal (or, in the case
of the start transition, at the creation of the agent).</p>
</div>
<div class="paragraph">
<p>When executed, a transition performs some task depending on the input signal and
on the state the agent is in (e.g., it may process input data, set <a href="#_timers">timers</a>,
send output <a href="#_signals">signals</a>, and possibly change the agent&#8217;s state), and then it returns.</p>
</div>
<div class="paragraph">
<p>To return (and as soon as possible) is the main requirement for a transition,
because the concurrency model of SDL is
<a href="http://en.wikipedia.org/wiki/Computer_multitasking#Cooperative_multitasking"><em>cooperative</em></a>:
a transition must not be blocking, that is, it must not contain infinite loops or calls to
blocking functions.</p>
</div>
<div class="paragraph">
<p>Each agent has a dedicated <a href="http://www.lua.org/manual/5.3/manual.html#2.2">Lua environment</a>
where the agent script and the transitions are executed, so global functions and variables of
an agent do not collide with those of other agents (they are <em>global</em> only in its dedicated
environment).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_start_transition">The start transition</h3>
<div class="paragraph">
<p>The <strong>start transition</strong> is the first transition of the agent&#8217;s state machine and is
automatically executed right after the agent has been created.</p>
</div>
<div class="paragraph">
<p>When an agent is created, LunaSDL first initializes its dedicated Lua environment, then
it loads and executes the agent script, and finally it calls the start transition function
that was set by the script with <a href="#sdl.start"><em>sdl.start</em></a>.
The function receives as arguments those (if any) that were in turn passed to the
<a href="#_creating_agents">create function</a> in its variable arguments part.</p>
</div>
<div class="paragraph">
<p>The start transition must contain a <a href="#sdl.nextstate"><em>sdl.nextstate</em></a> call to set the
first state entered by the agent, or end with a <a href="#sdl.stop"><em>sdl.stop</em></a> call to terminate
the agent without entering any state.</p>
</div>
<div class="paragraph">
<p>Once the start transition is executed, the control returns to the parent agent. The newly
created agent will then be awakened again whenever an input <a href="#_signals">signal</a> addressed
to it is dispatched by the event loop, causing the execution of the proper transition
which is determined as described below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_receiving_input_signals">Receiving input signals</h3>
<div class="paragraph">
<p>When an input <a href="#_signals">signal</a> is dispatched to an agent, LunaSDL determines the
transition triggered by it, then it executes it in the agent&#8217;s dedicated Lua environment.</p>
</div>
<div class="paragraph">
<p>Assuming the signal name is <em>signame</em>, and the agent&#8217;s current state is <em>state</em>,
the triggered transition is the first found by LunaSDL in the list that follows and
in the exposed order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the <a href="#sdl.transition">transition</a> explicitly defined in <em>state</em> for <em>signame</em>, or</p>
</li>
<li>
<p>the <a href="#asterisktransition"><em>asterisk</em> transition</a> defined in <em>state</em>, or</p>
</li>
<li>
<p>the transition explicitly defined in the <a href="#sdl.default">default state</a> for <em>signame</em>, or</p>
</li>
<li>
<p>the <em>asterisk</em> transition defined in the default state, or</p>
</li>
<li>
<p>the <em>empty transition</em>, which implicitly consumes the signal by doing nothing
and leaving the agent in the state it was before the arrival of the signal.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The signal contents and other relevant information such as the sender&#8217;s pid are
passed to the agent by means of some <a href="#_special_variables">special variables</a> that are
properly set by LunaSDL before executing the transition (the special variables are
those prescribed by the <a href="http://www.itu.int/rec/T-REC-Z/en">SDL standards</a>, with a few
additions).</p>
</div>
</div>
<div class="sect2">
<h3 id="_stopping_an_agent">Stopping an agent</h3>
<div class="paragraph">
<p>A <a href="#sdl.stop"><em>sdl.stop</em></a> call in a transition causes the end of the agent&#8217;s state
machine and puts the agent in a <strong>stopping condition</strong> which preludes its termination.</p>
</div>
<div class="paragraph">
<p>The agent remains in the stopping condition until all its children have terminated,
then it terminates too. While in the stopping condition, it will not receive any input
signal (its state machine has ended), but it will remain available for
<a href="#_remote_functions">remote functions</a> calls.</p>
</div>
<div class="paragraph">
<p>If an <em>atstopfunc</em> finalizer is passed when invoking <a href="#sdl.stop"><em>sdl.stop</em></a>, it is
executed right before the agent actually terminates and after all his children have terminated.</p>
</div>
<div class="paragraph">
<p>If the stopping agent is the system agent, its termination causes also the termination
of the <a href="#eventloop">event loop</a> and the return from the
<a href="#sdl.createsystem"><em>sdl.createsystem</em></a> function call. Notice that this happens when the
system agent actually terminates, i.e. when all its descendants have already terminated
(and thus it is the last agent left in the system).</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_agents">Creating agents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Agents are created using the functions that follow, all of them accepting the same
arguments, namely:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
name
</td>
<td class="hdlist2">
<p>the agent&#8217;s name (a string), which is required to be unique in the
block the agent is contained in.
If <em>name=nil</em>, then the default name <em>"agent&lt;pid&gt;"</em> is automatically assigned
to the agent (for example, the default name for the system agent is <em>"agent0"</em>).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
script
</td>
<td class="hdlist2">
<p>the agent script defining the <a href="#_agent_scripts">agent</a> (see also
<a href="#_finding_agent_scripts"><em>Finding agent scripts</em></a> below).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
...
</td>
<td class="hdlist2">
<p>optional arguments to be passed to the <a href="#sdl.start">start transition function</a>
set by the script.</p>
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.createsystem" class="ulist">
<ul>
<li>
<p><strong>sdl.createsystem</strong> ( <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )<br>
&#8594; <em>true</em>, <em>returnvalues</em><br>
<br>
Creates the <em>system agent</em> and enters the event loop. Any other agent must be created
by the system agent itself or by one of its descendants using the
<a href="#sdl.createblock"><em>sdl.createblock</em></a> or the <a href="#sdl.create"><em>sdl.create</em></a> functions
described below.<br>
<br>
This function exits the loop and returns only when the system agent terminates - which can
happen only after all the other agents have terminated too -  or if an error occurs, in which
case it returns <em>nil</em> and an error message (notice that this means that it does not call
Lua&#8217;s <a href="http://www.lua.org/manual/5.3/manual.html#pdf-error"><em>error</em></a> function as most LunaSDL
functions do).<br>
<br>
On success, the function returns <em>true</em>, possibly followed by a list of values
(if any were set, during the execution of the system, using the
<a href="#sdl.systemreturn"><em>sdl.systemreturn</em></a> function).<br></p>
</li>
</ul>
</div>
<hr>
<div id="sdl.createblock" class="ulist">
<ul>
<li>
<p><strong>sdl.createblock</strong> ( <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )<br>
&#8594; <em>pid</em><br>
<br>
Creates an agent of the SDL kind <em>block</em> and returns its <em>pid</em>. A block agent can be created only by other block agents, including the system agent (which is also a block, although a special one).</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.create" class="ulist">
<ul>
<li>
<p><strong>sdl.create</strong> ( <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )<br>
&#8594; <em>pid</em><br>
<br>
Creates an agent of the SDL kind <em>process</em> and returns its <em>pid</em>. A process agent can be created
either by block agents (including the system agent) or by other processes.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_system_return_values">System return values</h3>
<div id="sdl.systemreturn" class="ulist">
<ul>
<li>
<p><strong>sdl.systemreturn</strong> ( <em>&#8230;&#8203;</em> )<br>
<br>
Sets the values to be returned by the <a href="#sdl.createsystem"><em>sdl.createsystem</em></a> function
when the system stops gracefully.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_finding_agent_scripts">Finding agent scripts</h3>
<div class="paragraph">
<p>To find agent scripts, the functions of the <em>sdl.create</em> family use the same
mechanism that Lua uses to find modules and packages.</p>
</div>
<div class="paragraph">
<p>More precisely, the <em>script</em> argument is resolved by invoking the standard Lua
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-package.searchpath"><em>package.searchpath</em></a>
function, passing it the templates contained in the variable <strong><em>sdl.path</em></strong> as the
argument for the <em>path</em> parameter.</p>
</div>
<div class="paragraph">
<p>The <em>sdl.path</em> variable defaults to <code><em>"?;?.lua"</em></code> so that if, for example, an agent
is created like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"> <span class="tok-n">pid</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">myagentname&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">mydir.myscript&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then LunaSDL searches for a file named <code><em>"mydir/myscript"</em></code> or <code><em>mydir/myscript.lua"</em></code>,
in this order.</p>
</div>
<div class="paragraph">
<p>The default <em>sdl.path</em> can be overridden by setting the <code>LUNASDL_PATH</code> environment
variable with the desired path templates (in the same way one sets the standard <code>LUA_PATH</code>
variable to override the default
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-package.path"><em>package.path</em></a>).</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_signals">Signals</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_format_of_signals">Format of signals</h3>
<div class="paragraph">
<p>Signals exchanged between agents in LunaSDL, as well as signals generated by
<a href="#_timers">timers</a>, are Lua tables whose first array element (i.e. the element
with numeric key=<em>1</em>) must be a string and denotes the <strong>signal name</strong>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"> <span class="tok-n">mysignal</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-s2">&quot;</span><span class="tok-s">MYSIGNAL&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">hello&quot;</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-n">self_</span><span class="tok-p">,</span> <span class="tok-kc">true</span> <span class="tok-p">}</span>
 <span class="tok-c1">-- &quot;MYSIGNAL&quot; is the signal name; the fields values follow</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The signal in the example above has only array fields, but the record part of the table
can also be used.</p>
</div>
<div class="paragraph">
<p>Besides expecting the signal name in the first array position, LunaSDL makes no other
assumptions regarding the format and meaning of signals and of their contents: it just
delivers them between agents. Note that signals are <strong>sent by reference</strong>.</p>
</div>
<div class="paragraph">
<p>The functions that can be used by agents to send, save and possibly re-schedule saved
signals are described in the following subsections.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending_signals">Sending signals</h3>
<div id="sdl.send" class="ulist">
<ul>
<li>
<p><strong>sdl.send</strong> ( <em>signal</em>, <em>dstpid</em>, [, <em>priority</em> ])<br>
&#8594; <em>now</em><br>
<br>
Sends the SDL <em>signal</em> to the agent identified by <em>dstpid</em>, with the specified
<em>priority</em>, and returns the current <a href="#_system_time">time</a>.<br>
<br>
The <em>priority</em> argument, if present, should be an integer between <em>1</em> (high)
and <em>N</em> (low), where <em>N</em> is the <a href="#sdl.prioritylevels">number of priority levels</a>
optionally configured at startup.<br>
<br>
If <em>priority</em> is not specified, or if it is greater than <em>N</em>, the signal
is sent without priority (which means lowest).<br></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The SDL-experienced reader may have noticed that LunaSDL has <em>priority
outputs</em>, while standard SDL has <em>priority inputs</em>. The following function somehow
straightens things by allowing the receiver agent to specify the priorities of input
signals, and override the priorities specified by sender agents.
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.priorityinput" class="ulist">
<ul>
<li>
<p><strong>sdl.priorityinput</strong> ( <em>signame</em>, [ <em>priority</em> ] )<br>
<br>
Configures the <em>priority</em> for input signals named <em>signame</em>.<br>
<br>
This function is (optionally) used by an agent to impose priorities for input signals.
If it is called with a non-<em>nil</em> <em>priority</em> argument, then signals named <em>signame</em> sent
to this agent will be sent with the specified <em>priority</em>, no matter the priority specified
by the sender.<br>
<br>
If <em>priority</em> is <em>nil</em>, the desired priority is reset and the priority specified by the
sender applies.<br>
<br>
The <em>sdl.priorityinput</em> function can be used by an agent at any time, but only signals sent
after it is called are affected by it, i.e. signals already sent but not yet dispatched
are not affected (so, beware of subtle differences with the standard SDL priority input
construct).<br>
<br>
Signals generated by <a href="#_timers">timers</a>, <a href="#_time_triggered_signals">time-triggered signals</a>
and <a href="#sdl.restore">re-scheduled signals</a> are not affected either.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_time_triggered_signals">Time-triggered signals</h3>
<div id="sdl.sendat" class="ulist">
<ul>
<li>
<p><strong>sdl.sendat</strong> ( <em>signal</em>, <em>dstpid</em>, <em>at</em> [, <em>maxdelay</em> ])<br>
<br>
Schedules the SDL <em>signal</em> to be sent to the agent identified by <em>dstpid</em> at the
point in <a href="#_system_time">time</a> specified by <em>at</em>.<br>
<br>
The optional <em>maxdelay</em> argument is the maximum delay, in seconds after <em>at</em>, after
which the signal must be considered stale, and discarded. A <em>nil</em> value for <em>maxdelay</em>
means <em>infinity</em> (i.e. the signal never expires).<br>
<br>
When a signal is sent with this function, LunaSDL retains it in an internal queue
and only when the time specified by the <em>at</em> argument arrives, it sends it to the
destination agent (with maximum priority).
If, for some reason, the signal can not be delivered before the point in time given by
<em>at + maxdelay</em>, LunaSDL silently discards it.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This construct is not part of the SDL standard. It is instead inspired
by a proposal contained in the paper &#8220;Real-time signaling in SDL&#8221;,
by M. Krmer, T. Braun, D. Christmann and R. Gotzhein, published in <em>SDL'11
Proceedings of the 15th international conference on Integrating System and
Software Modeling</em>, Springer-Verlag, 2011.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_saving_and_re_scheduling_signals">Saving and re-scheduling signals</h3>
<div id="sdl.save" class="ulist">
<ul>
<li>
<p><strong>sdl.save</strong> ( )<br>
<br>
To be used within <a href="#_agent_scripts">transitions</a> triggered by input signals,
saves the current input signal (i.e. the content of the
<strong><em>signal_</em></strong> <a href="#_special_variables">special variable</a>) in the agent&#8217;s <em>saved queue</em>, for later
re-scheduling.<br>
<br>
Saved signals are automatically re-scheduled when the agent changes its state
with a <a href="#sdl.nextstate"><em>sdl.nextstate</em></a> call, but can be re-scheduled explicitly
at any time by means of the <a href="#sdl.restore"><em>sdl.restore</em></a> function described below.<br>
<br>
In both cases, saved signals are re-scheduled without priority (even if they
were originally sent with priority) and in the same order they were saved.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.restore" class="ulist">
<ul>
<li>
<p><strong>sdl.restore</strong> ( )<br>
<br>
Explicitly re-schedules all the signals saved in the agent&#8217;s <em>saved queue</em>.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_timers">Timers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SDL agents can create and manage timers using the functions described here.</p>
</div>
<hr>
<div id="sdl.timer" class="ulist">
<ul>
<li>
<p><strong>sdl.timer</strong> ( <em>duration</em>, <em>signame</em> )<br>
&#8594; <em>tid</em><br>
<br>
Creates an SDL timer and returns a unique <strong>timer identifier (tid)</strong> to be used in
subsequent operations. The timer is <em>owned</em> by the agent that created it.
Timer functions can be invoked on a specific timer only by its owner agent or
by <a href="#_procedures">procedures</a> that act on its behalf.<br>
<br>
The <em>duration</em> parameter is the timer&#8217;s default timeout in seconds, and the
<em>signame</em> parameter (a string) is the name of the SDL signal sent by LunaSDL to the
owner agent when the timer expires.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A timer can be created by an agent only before the execution of its start
transition. Timers can not be created in state transitions, including the start
transition, nor within procedures. Procedures can, however, use timers owned by
their calling agent.
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.modify" class="ulist">
<ul>
<li>
<p><strong>sdl.modify</strong> ( <em>tid</em>, <em>duration</em> [, <em>signame</em> ] )<br>
<br>
Modifies the default duration and/or the signal name of the timer identified by <em>tid</em>
(to modify only the signal name, <em>nil</em> must be passed explicitly as argument for <em>duration</em>).<br>
<br>
The <em>duration</em> and <em>signame</em> parameters have the same meaning as for the
<a href="#sdl.timer"><em>sdl.timer</em></a> function above.<br>
<br>
If the timer is active, this function also resets (stops) it.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.set" class="ulist">
<ul>
<li>
<p><strong>sdl.set</strong> ( <em>tid</em> [, <em>at</em> ] )<br>
&#8594; <em>now</em><br>
<br>
Sets (starts) the timer identified by <em>tid</em> so to expire at the point in <a href="#_system_time">time</a>
given by <em>at</em>, and returns the current time.<br>
<br>
The <em>at</em> parameter is optional and defaults to <a href="#sdl.now"><em>sdl.now()</em></a> <em>+ duration</em>,
where <em>duration</em> is the default duration specified for the timer.<br>
<br>
When the timer expires, an SDL signal is sent to the owner agent. Such signal contains
only the signal name specified when the timer was created or later modified.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.reset" class="ulist">
<ul>
<li>
<p><strong>sdl.reset</strong> ( <em>tid</em> )<br>
&#8594; <em>now</em><br>
<br>
Resets (stops) the timer identified by <em>tid</em> and returns the current <a href="#_system_time">time</a>.
If the timer is not active, <em>sdl.reset</em> has no effect and generates no errors.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.active" class="ulist">
<ul>
<li>
<p><strong>sdl.active</strong> ( <em>tid</em> )<br>
&#8594; <em>isactive</em>, <em>at</em><br>
<br>
Returns information about the status of the timer identified by <em>tid</em>. The return
values are: <em>isactive</em>, a boolean indicating whether the timer is active or not, and
<em>at</em>, which is the point in <a href="#_system_time">time</a> at which the timer is expected to
expire (if the timer is not active, then Lua&#8217;s
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-math.huge"><em>math.huge</em></a> is returned as <em>at</em>).</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_system_time">System time</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A LunaSDL application has a wallclock that gives the so-called <strong>SDL system time</strong>
(or, shortly, the <em>system time</em>). The wallclock is started when the LunaSDL module is first
loaded, so the system time is relative to that point in time, unless the wallclock
is reset during the <a href="#_optional_configurations">configuration phase</a>.</p>
</div>
<hr>
<div id="sdl.now" class="ulist">
<ul>
<li>
<p><strong>sdl.now</strong> ( )<br>
&#8594; <em>timestamp</em><br>
<br>
Returns the current system time, in seconds.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.since" class="ulist">
<ul>
<li>
<p><strong>sdl.since</strong> ( <em>timestamp</em> )<br>
&#8594; <em>timedifference</em><br>
<br>
Returns the time elapsed from the point in time given by <em>timestamp</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.startingtime" class="ulist">
<ul>
<li>
<p><strong>sdl.startingtime</strong> ( ) <br>
&#8594; <em>startingtime</em><br>
<br>
Returns the absolute timestamp corresponding to the point <em>0 (zero)</em> of the system time.
The meaning of this timestamp depends on the underlying function used to retrieve
time from the operating system (see <a href="#sdl.setwallclock"><em>sdl.setwallclock</em></a> for more
details).</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_agent_information">Agent information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The functions described below provide information about SDL agents and help
agents in locating each other.</p>
</div>
<div class="paragraph">
<p>For those functions accepting an optional <em>pid</em> parameter, this defaults to <strong><em>self_</em></strong>
(i.e. to the pid of the agent invoking the function).</p>
</div>
<div class="paragraph">
<p>On error, for example if the agent searched for does not exist, all these functions
return <em>nil</em> and an error message in the typical Lua way (notice that this means
that they do not call Lua&#8217;s <a href="http://www.lua.org/manual/5.3/manual.html#pdf-error"><em>error</em></a>
function, as most of other LunaSDL functions do, so the caller should check the return value).</p>
</div>
<hr>
<div id="sdl.pidof" class="ulist">
<ul>
<li>
<p><strong>sdl.pidof</strong> ( <em>name</em> [, <em>block</em> ])<br>
&#8594; <em>pid</em><br>
<br>
Searches for the SDL agent named <em>name</em> (a string) in the SDL block identified
by the pid <em>block</em>, and returns its pid. The <em>block</em> parameter is optional and defaults
to <strong><em>block_</em></strong> (i.e. to the pid of the block the invoking agent is contained in).</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.nameof" class="ulist">
<ul>
<li>
<p><strong>sdl.nameof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>name</em><br>
<br>
Returns the name of the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.blockof" class="ulist">
<ul>
<li>
<p><strong>sdl.blockof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>block</em><br>
<br>
Returns the pid of the block containing the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.parentof" class="ulist">
<ul>
<li>
<p><strong>sdl.parentof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>ppid</em><br>
<br>
Returns the pid of the parent of the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.kindof" class="ulist">
<ul>
<li>
<p><strong>sdl.kindof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>kind</em><br>
<br>
Returns the SDL <em>kind</em> of the agent identified by <em>pid</em>.
The returned value (a string) is one amongst <em>"system"</em>, <em>"block"</em>, <em>"process"</em> or <em>"procedure"</em>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A <a href="#_procedures">procedure</a> is not really an SDL agent, but in LunaSDL it
is implemented as a special kind of agent so it is also identified by a pid and has
a name.
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.stateof" class="ulist">
<ul>
<li>
<p><strong>sdl.stateof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>state</em><br>
<br>
Returns the current state (a string) of the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.childrenof" class="ulist">
<ul>
<li>
<p><strong>sdl.childrenof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>childrenlist</em><br>
<br>
Returns the pids of the children created by the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.timersof" class="ulist">
<ul>
<li>
<p><strong>sdl.timersof</strong> ( [ <em>pid</em> ] )<br>
&#8594; <em>timerslist</em><br>
<br>
Returns the tids of the timers owned by the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.treeof" class="ulist">
<ul>
<li>
<p><strong>sdl.treeof</strong> ( [ <em>pid</em> ] )<br>
<br>
Returns a string containing a description of the sub-<a href="#_agents_hierarchy">tree of agents</a>
rooted at the agent identified by <em>pid</em>.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_procedures">Procedures</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>SDL procedures</strong> are sub-parts of state machines, that can be reused in
different agent scripts.</p>
</div>
<div class="paragraph">
<p>A procedure in LunaSDL is implemented as a special kind of agent, created by
means of the <a href="#sdl.procedure"><em>sdl.procedure</em></a> function, that replaces its
caller from when it is called until it returns.
More precisely, a procedure replaces its caller <em>as destination and source of
signals</em>, i.e. all the signals addressed to the caller are redirected to the
procedure, which may consume them or <a href="#sdl.save">save</a> them, and all the signals
sent by the procedure are sent on behalf of its caller (in other words, with
the caller&#8217;s pid as <em>sender</em>).</p>
</div>
<div class="paragraph">
<p>When a procedure returns, all the signal it saved are automatically moved in
its parent&#8217;s <em>saved queue</em> and the normal addressing  of signals is re-established.</p>
</div>
<div class="paragraph">
<p>Procedures can be nested, that is, a procedure may call another procedure,
but agents (and procedures) can directly execute only one procedure at a time
because they are replaced by it. Nested procedures all act on behalf of the original
caller, whose pid they find in the <strong><em>caller_</em></strong> <a href="#_special_variables">special variable</a>.</p>
</div>
<div class="paragraph">
<p>State machines for procedures are defined in <em>procedure scripts</em> with the same
functions used in regular <a href="#_agent_scripts">agent scripts</a>, with the exception
of the <a href="#sdl.stop"><em>sdl.stop</em></a> function (procedure scripts shall use the
<a href="#sdl.procreturn"><em>sdl.procreturn</em></a> function instead).</p>
</div>
<div class="paragraph">
<p>Another difference with regular agents is that procedures may not create timers,
but they can use timers owned by the agent they act on behalf of.</p>
</div>
<hr>
<div id="sdl.procedure" class="ulist">
<ul>
<li>
<p><strong>sdl.procedure</strong> (<em>atreturn</em>, <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )<br>
&#8594; <em>pid</em><br>
<br>
Executes (i.e. creates) an SDL procedure as described above.
The <em>name</em>, <em>script</em> and <em>&#8230;&#8203;</em> arguments are the same as in the functions that
<a href="#_creating_agents">create regular agents</a>
(the only difference is that if <em>name=nil</em>, then the default name <em>"procedure&lt;pid&gt;"</em>
is automatically assigned instead of <em>"agent&lt;pid&gt;"</em>).<br>
<br>
The <em>atreturn</em> argument defines actions to be executed in the caller agent&#8217;s environment
when the procedure returns. It may be a function, a string denoting a state, or <em>nil</em>
if no actions need to be executed.<br>
<br>
When the procedure returns, if <em>atreturn</em> is a function, it is executed passing it
as arguments the values returned by the procedure (if any). If <em>atreturn</em> is a string,
then <a href="#sdl.nextstate"><em>sdl.nextstate(atreturn)</em></a> is automatically executed instead.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.procreturn" class="ulist">
<ul>
<li>
<p><strong>sdl.procreturn</strong> ( <em>&#8230;&#8203;</em> )<br>
<br>
Returns from a procedure. This function is to be used in the procedure script
instead of <a href="#sdl.stop"><em>sdl.stop</em></a>, to terminate the procedure and possibly
return values to the parent.<br>
<br>
The arguments passed to <em>sdl.procreturn</em> (if any) are in turn passed to the
<em>atreturn</em> function set by the parent when the procedure was created.<br>
<br>
No script code should follow a call of this function.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_remote_functions">Remote functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remote functions are Lua functions defined in the environment of an
agent (the <em>exporting agent</em>) that can be invoked by another agent (the <em>invoking agent</em>).</p>
</div>
<div class="paragraph">
<p>When the invoking agent calls a remote function, LunaSDL switches to the exporting
agent&#8217;s environment, it executes the function there, and then it switches back to the
invoking agent&#8217;s environment returning it any value returned by the function. That is,
the remote function is executed synchronously and immediately.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This is a non-SDL construct, not to be confused with SDL <em>remote procedures</em>
(see ITU-T Z.102/10.5) that have a different mechanism involving exchange of signals.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The remote function mechanism relies on the following two functions.</p>
</div>
<hr>
<div id="sdl.exportfunc" class="ulist">
<ul>
<li>
<p><strong>sdl.exportfunc</strong> ( <em>funcname</em>, [ <em>func</em> ] )<br>
<br>
Exports the function <em>func</em> with the name <em>funcname</em> (a string), so that it can be invoked
by other agents using <a href="#sdl.remfunc"><em>sdl.remfunc</em></a>.<br>
<br>
Calling <em>sdl.exportfunc</em> without the <em>func</em> argument revokes the function.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.remfunc" class="ulist">
<ul>
<li>
<p><strong>sdl.remfunc</strong> ( <em>pid</em>, <em>funcname</em>, <em>&#8230;&#8203;</em> )<br>
&#8594; <em>returnvalues</em><br>
<br>
Executes the function exported with the name <em>funcname</em> in the environment of the
exporting agent identified by <em>pid</em>, and returns the function&#8217;s return values (if any).
The <em>&#8230;&#8203;</em> variable arguments, if any, are passed as arguments to the remote function.<br>
<br>
The invoked function must have been previously exported with
<a href="#sdl.exportfunc"><em>sdl.exportfunc</em></a> by the exporting agent.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_event_loop">The event loop</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As already stated in the <a href="#_overview">Overview</a>, LunaSDL has an event loop that
waits for stimuli such as the expiries of timers, or file descriptor objects that
have become ready for I/O operation, and that dispatches signals sent by agents
or generated by timers.</p>
</div>
<div class="paragraph">
<p>The event loop relies on a <strong>poll function</strong> that it uses to poll file descriptor
objects for readiness and to get the timing for timers.
By default, this function is <a href="https://github.com/diegonehab/luasocket">LuaSocket</a>'s
<em>select</em>, and the <strong>file descriptor objects</strong> that LunaSDL supports are LuaSocket&#8217;s
sockets (and compatible objects). This can be changed in the optional configuration
phase by means of the <a href="#sdl.pollfuncs"><em>sdl.pollfuncs</em></a> function.</p>
</div>
<div class="paragraph">
<p>Agents may create and use file descriptor objects with the API provided by LuaSocket
or by alternative modules, and register them in the event loop together with callbacks
to be invoked whenever they are ready for I/O operations.</p>
</div>
<div class="paragraph">
<p>LunaSDL is fairly agnostic with respect to what a 'file descriptor object' is: it
only expects it to be compatible with the <em>poll function</em>, and to support a couple
of methods: a <em>settimeout</em> method which LunaSDL calls with a <em>0</em> timeout argument
to force the object to be non-blocking, and a <em>__tostring</em> metamethod (for traces).</p>
</div>
<div class="paragraph">
<p>Multiple file descriptor objects can be used concurrently, with the only requirement
that they must not be blocking, otherwise they would block the timers and the
dispatching of signals (LunaSDL forces the file descriptors timeout to <em>0</em> when they
are registered, and this should not be changed by the agent scripts).</p>
</div>
<div class="sect2">
<h3 id="_registering_file_descriptors">Registering file descriptors</h3>
<div class="paragraph">
<p>Registration and deregistration of file descriptor objects in the event loop is done
with the following two functions:</p>
</div>
<hr>
<div id="sdl.register" class="ulist">
<ul>
<li>
<p><strong>sdl.register</strong> ( <em>object</em>, <em>readcallback</em> [, <em>writecallback</em> ])<br>
<br>
Registers a file descriptor object in the event loop. The <em>object</em> argument must be
compatible with the <a href="#sdl.pollfuncs"><em>poll functiont</em></a> used by LunaSDL
(e.g., if the default configuration is used, then <em>object</em> must be a LuaSocket socket or
a compatible object).<br>
<br>
If <em>readcallback</em> is not <em>nil</em>, then the event loop invokes <code>readcallback(object)</code>
whenever it detects that <em>object</em> is ready for read operations. Similarly,
if <em>writecallback</em> is not <em>nil</em>, then the event loop invokes <code>writecallback(object)</code>
whenever it detects that <em>object</em> is ready for write operations.<br>
<br>
Callbacks are executed in the environment of the agent that registered the object,
with the same agent set as <em>current</em>
(a callback is, de facto, a <a href="#_transitions">transition</a> that instead of being triggered
by the arrival of an input signal, it is triggered by the detection of the readiness of
a file descriptor object).<br></p>
</li>
</ul>
</div>
<hr>
<div id="sdl.deregister" class="ulist">
<ul>
<li>
<p><strong>sdl.deregister</strong> ( <em>object</em> [, <em>mode</em> ])<br>
<br>
Deregisters <em>object</em> from the event loop. The optional <em>mode</em> argument (a string)
specifies if the object must be deregistered for read operations (<em>"r"</em>), for
write operations (<em>"w"</em>), or for both (<em>"rw"</em> or <em>"wr"</em>). If not passed, <em>mode</em> defaults
to <em>"rw"</em>. Deregistration of not registered objects do not cause errors.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_sockets">Sockets</h3>
<div class="paragraph">
<p>If the default <em>poll function</em> (i.e. LuaSocket&#8217;s <em>socket.select</em>) is used, then agents
may create and use sockets with the API provided by LuaSocket, registering them in the
event loop with the <a href="#sdl.register"><em>sdl.register</em></a> function.</p>
</div>
<div class="paragraph">
<p>Notice that the <em>socket. select</em> function supports also custom <em>file descriptor</em>
objects (i.e. other than sockets), provided they have a couple of methods needed by
<em>socket.select</em> to deal with them.
For more details, see <a href="https://github.com/diegonehab/luasocket">LuaSocket</a>'s documentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_event_loop_details">Event loop details</h3>
<div class="paragraph">
<p>Roughly speaking, at each round the event loop does the following operations, in the
order they are exposed here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, it waits for stimuli. As already stated, stimuli may be the expiry of timers,
or the readiness of registered file descriptors objects for I/O operations.
How long the event loop waits, it depends on the presence of signals yet to be dispatched:
if there are any, it just gives a glance for stimuli (i.e. it polls with a
<em>0</em> timeout) and then it goes on to the next point as soon as possible. Otherwise
it waits indefinitely until the next stimulus.</p>
</li>
<li>
<p>Then, if any file descriptor object is ready for I/O, it invokes the corresponding callback.
The callback execution may result in the scheduling of signals. Any such signal will
be dispatched later in this same round.</p>
</li>
<li>
<p>Then, for any timer that has expired since the previous round, it schedules the
corresponding signal to be delivered to the timer&#8217;s owner agent. This signal will
also be dispatched in this same round.</p>
</li>
<li>
<p>Finally, it dispatches all signals scheduled until now, in their order of priority.
The dispatching of these signals may again result in the scheduling of new signals,
but these will be dispatched in the next round (this is to avoid deadlocks).</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_logs_and_traces">Logs and traces</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_logs">Logs</h3>
<div class="paragraph">
<p>A LunaSDL application can open a <strong>system logfile</strong> and use the functions described
here to write on it. The system logfile is also used by LunaSDL as destination for
<a href="#_traces">traces</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Of course, nothing prevents an application to open other logfiles and write
on them using the standard Lua libraries.
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.logopen" class="ulist">
<ul>
<li>
<p><strong>sdl.logopen</strong> ( <em>filename</em> )<br>
&#8594; <em>filehandle</em><br>
<br>
Opens the file named <em>filename</em> to be used as system logfile, and enables logs.
The file is opened in write mode, using the standard Lua
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-io.open"><em>io.open</em></a>.
If the system logfile is already open, it is closed and re-opened.
Any previously existing file with the same name is overwritten.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If the system logfile is not open, or if it is disabled, calls of the following
functions are silently ignored and raise no errors.
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.logfile" class="ulist">
<ul>
<li>
<p><strong>sdl.logfile</strong> ( )<br>
&#8594; <em>filehandle</em>, <em>filename</em><br>
<br>
Returns the file handle and the file name of the system logfile (if it is open, otherwise
it returns <em>nil</em> and an error message).</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.logson" class="ulist">
<ul>
<li>
<p><strong>sdl.logson</strong> ( )<br></p>
</li>
<li>
<p><strong>sdl.logsoff</strong> ( )<br>
<br>
Enable/disable logs on the system logfile, if it is open. Logs are enabled by default
at the opening of the system logfile. These functions can be used to define &#8216;logging windows&#8217;.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.logflush" class="ulist">
<ul>
<li>
<p><strong>sdl.logflush</strong> ( )<br>
<br>
Flushes the system logfile. LunaSDL automatically flushes it only at its closure
or when the system agent stops.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.logclose" class="ulist">
<ul>
<li>
<p><strong>sdl.logclose</strong> ( )<br>
<br>
Flushes and closes the system logfile.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.logf" class="ulist">
<ul>
<li>
<p><strong>sdl.logf</strong> ( <em>formatstring</em>, <em>&#8230;&#8203;</em> )<br>
<br>
Formats its arguments using the standard Lua
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-string.format"><em>string.format</em></a>,
and writes the resulting message to the system logfile, prepending it with a
<a href="#_system_time">timestamp</a> and the pid of the current SDL agent.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.printf" class="ulist">
<ul>
<li>
<p><strong>sdl.printf</strong> ( <em>formatstring</em>, <em>&#8230;&#8203;</em> )<br>
<br>
Same as <a href="#sdl.logf"><em>sdl.logf</em></a> above, it additionally writes the message on <em>stdout</em> also
(without the timestamp and the pid preamble).
If the system logfile is not open or if logs are disabled, it writes on <em>stdout</em> only.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_traces">Traces</h3>
<div class="paragraph">
<p>Traces are conditional logs, also written on the system logfile. Each trace is
associated with a <strong><em>tag</em></strong> (a string), and it is written on the system logfile only
if traces are enabled for that specific tag.</p>
</div>
<div class="paragraph">
<p>A few traces are produced by LunaSDL for troubleshooting, but application code may
produce traces too.</p>
</div>
<hr>
<div id="sdl.traceson" class="ulist">
<ul>
<li>
<p><strong>sdl.traceson</strong> ( <em>&#8230;&#8203;</em> )<br>
<br>
Enables traces. The function accepts an optional list of tags. If one or
more tags are passed as argument, it adds them to the list of enabled tags.
Otherwise it enables traces however tagged.<br>
<br>
By default, traces are disabled for any tag.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.tracesoff" class="ulist">
<ul>
<li>
<p><strong>sdl.tracesoff</strong> ( <em>&#8230;&#8203;</em> )<br>
<br>
Disables traces. Accepts an optional list of tags. If one or more tags are
passed as argument, it adds them to the list of disabled tags.
Otherwise it disables traces however tagged.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.trace" class="ulist">
<ul>
<li>
<p><strong>sdl.trace</strong> ( <em>tag</em>, <em>formatstring</em>, <em>&#8230;&#8203;</em> )<br>
<br>
Similar to <a href="#sdl.logf"><em>sdl.logf</em></a>, with the differences that the formatted message is
written on the system logfile only if traces are enabled for the passed <em>tag</em> (a string),
and that the preamble contains the tag also.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optional_configurations">Optional configurations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The functions below allow to optionally configure some aspects of LunaSDL.
If they are used, they must be called before the creation of the system agent
(see the <a href="#_the_main_script">main script example</a>).</p>
</div>
<hr>
<div id="sdl.envtemplate" class="ulist">
<ul>
<li>
<p><strong>sdl.envtemplate</strong> ( <em>env</em> )<br>
<br>
Sets the template <a href="http://www.lua.org/manual/5.3/manual.html#2.2">Lua environment</a>
for environments dedicated to agents.<br>
<br>
The <strong><em>sdl</em></strong> global table, containing the functions described in this manual, is
automatically loaded in each agent&#8217;s dedicated environment, so it need not be
loaded explicitly in agent scripts (unless a different name is desired for it).<br>
<br>
If this function is not called, the template environment is a shallow copy
of the main environment (<em>_ENV</em>) at the time the <a href="#sdl.createsystem"><em>sdl.createsystem</em></a>
function is called.</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.pollfuncs" class="ulist">
<ul>
<li>
<p><strong>sdl.pollfuncs</strong> ( <em>poll</em>, [, <em>add</em> [, <em>del</em> [, <em>reset</em> ]]])<br>
<br>
Sets the function to be used by the <a href="#_the_event_loop">event loop</a> to
poll for stimuli, and its helper hooks.<br>
<br>
The passed <em>poll</em> function must have the same semantics of
<a href="https://github.com/diegonehab/luasocket">LuaSocket</a>'s <em>select</em>, which is used by
default if <em>sdl.pollfuncs</em> is not invoked. It may support different objects
than LuaSocket&#8217;s sockets, but they must have a <em>settimeout</em> method accepting a
<em>0</em> timeout to make them non-blocking, and a <em>__tostring</em> metamethod.<br>
<br>
If the optional <em>add</em> argument (a function) is passed, LunaSDL calls <code>add(object, mode)</code>
whenever an object is <a href="#sdl.register">registered</a> in the event loop.
Similarly, if the optional <em>del</em> argument (also a function) is passed, then LunaSDL
calls <code>del(object, mode)</code> whenever an object is <a href="#sdl.register">deregistered</a> from the
event loop.<br>
<br>
The <em>mode</em> argument passed to the <em>add</em> and <em>del</em> hooks has the same meaning and values
as in the <a href="#sdl.deregister"><em>sdl.deregister</em></a> function.<br>
<br>
Both the <em>add</em> and <em>del</em> hook are expected to return <em>true</em> on success, or <em>nil</em> and
a string error message on failure.<br>
<br>
If the optional <em>reset</em> argument (also a function) is passed, LunaSDL calls
<code>reset()</code> whenever it starts or re-starts the event loop.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
By means of the <em>add</em> and <em>del</em> hooks, the underlying implementation of the
<em>poll</em> function can mantain internally the two sets of file descriptor objects to
be polled, and avoid traversing the sets passed to it as arguments each time it is
called (which it can simply ignore). The <em>reset</em> hook is expected to delete the
internally mantained sets.
</td>
</tr>
</table>
</div>
<hr>
<div id="sdl.prioritylevels" class="ulist">
<ul>
<li>
<p><strong>sdl.prioritylevels</strong> ( [ <em>levels</em> ] )<br>
<br>
Configures the number of priority levels to be used in the LunaSDL scheduler
for <a href="#sdl.send">priority signals</a>.<br>
<br>
The <em>levels</em> argument must be an integer <em>&gt;=1</em>. If this function is not called,
the number of priority levels defaults to <em>1</em> (so, by default, there is one level
of priority plus the no-priority level).</p>
</li>
</ul>
</div>
<hr>
<div id="sdl.setwallclock" class="ulist">
<ul>
<li>
<p><strong>sdl.setwallclock</strong> ( [ <em>gettimefunc</em> ] )<br>
<br>
Sets the function to be used by LunaSDL to get timestamps from the underlying
operating system, and resets the <a href="#_system_time"><em>SDL system time</em></a> wallclock.<br>
<br>
The <em>gettimefunc</em> argument is expected to be a function that, whenever called,
returns a <em>double</em> representing the current time in seconds. Not passing the
<em>gettimefunc</em> just resets the wallclock.<br>
<br>
If <em>sdl.setwallclock</em> is not called, LunaSDL uses the <em>socket.gettime</em> function
provided by <a href="https://github.com/diegonehab/luasocket">LuaSocket</a>.<br></p>
</li>
</ul>
</div>
<hr>
<div id="sdl.traceback" class="ulist">
<ul>
<li>
<p><strong>sdl.traceback</strong> ( [ <em>s</em> ] )<br>
<br>
Enables the stack traceback in error messages. If <em>s = "off"</em>, it disables it.
The stack traceback is disabled by default.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_examples">Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the examples that are contained in the <code>examples/</code> directory
of the official LunaSDL release.</p>
</div>
<div class="paragraph">
<p>Some of them are accompanied with SDL diagrams, which are for illustratory
purposes only.</p>
</div>
<div class="sect2">
<h3 id="_hello_world">Hello World</h3>
<div class="paragraph">
<p>The first example is, of course, the traditional Hello World. Just to make
things a little more interesting, the salute is given with a delay of 1 second.</p>
</div>
<div class="paragraph">
<p>The <code>main.lua</code> script loads the LunaSDL module, then creates the system agent with
the <code>hello.lua</code> script. The latter implements the agent depicted in the diagram
below.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/helloworld/</code>. The example
can be run at the shell prompt with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell">[examples/helloworld ]$ lua main.lua</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../examples/helloworld/hello.png" alt="Hello agent">
</div>
<div class="title">Figure 1. Hello agent</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>

<span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">HelloSystem&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">hello&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Agent script: hello.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">T</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">timer</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T_EXPIRED&quot;</span><span class="tok-p">)</span>

<span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">()</span>
   <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Just one second...&quot;</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">TExpired</span><span class="tok-p">()</span>
   <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Hello World!&quot;</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T_EXPIRED&quot;</span><span class="tok-p">,</span><span class="tok-n">TExpired</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ping_pong">Ping Pong</h3>
<div class="paragraph">
<p>In this example, the <code>main.lua</code> script creates the system agent with the <code>system.lua</code> script.
The system agent then creates two processes with the same agent script, <code>player.lua</code>, and
sends a <code>START</code> signal to one of them instructing it to start pinging the other, which in
turns pongs in response.
The system agent also sets a timer to control the duration of the ping-pong exchange,
and at the timer expiry it sends a <code>STOP</code> signal to both processes and stops itself.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/pingpong/</code>. Run the example at
the shell prompt with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell">[examples/pingpong ]$ lua main.lua</code></pre>
</div>
</div>
<div class="paragraph">
<p>(You can also pass the test duration and the ping interval as arguments, in this order).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">duration</span> <span class="tok-o">=</span> <span class="tok-nb">tonumber</span><span class="tok-p">(({</span><span class="tok-o">...</span><span class="tok-p">})[</span><span class="tok-mi">1</span><span class="tok-p">])</span> <span class="tok-ow">or</span> <span class="tok-mi">10</span> <span class="tok-c1">-- seconds</span>
<span class="tok-kd">local</span> <span class="tok-n">interval</span> <span class="tok-o">=</span> <span class="tok-nb">tonumber</span><span class="tok-p">(({</span><span class="tok-o">...</span><span class="tok-p">})[</span><span class="tok-mi">2</span><span class="tok-p">])</span> <span class="tok-ow">or</span> <span class="tok-mi">1</span> <span class="tok-c1">-- seconds</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logopen</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">example.log&quot;</span><span class="tok-p">)</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">System&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">,</span><span class="tok-n">duration</span><span class="tok-p">,</span><span class="tok-n">interval</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../examples/pingpong/system.png" alt="system">
</div>
<div class="title">Figure 2. System agent</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- System agent script: system.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">T1</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">timer</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T1_EXPIRED&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">local</span> <span class="tok-n">player1</span><span class="tok-p">,</span> <span class="tok-n">player2</span>

<span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">(</span><span class="tok-n">duration</span><span class="tok-p">,</span> <span class="tok-n">interval</span><span class="tok-p">)</span>
   <span class="tok-kd">local</span> <span class="tok-n">duration</span> <span class="tok-o">=</span> <span class="tok-n">duration</span> <span class="tok-ow">or</span> <span class="tok-mi">10</span>
   <span class="tok-kd">local</span> <span class="tok-n">interval</span> <span class="tok-o">=</span> <span class="tok-n">interval</span> <span class="tok-ow">or</span> <span class="tok-mi">1</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: duration=%u s, interval=%u s&quot;</span><span class="tok-p">,</span><span class="tok-n">name_</span><span class="tok-p">,</span><span class="tok-n">duration</span><span class="tok-p">,</span> <span class="tok-n">interval</span><span class="tok-p">)</span>

   <span class="tok-n">player1</span><span class="tok-o">=</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">player1&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">player&quot;</span><span class="tok-p">,</span><span class="tok-n">interval</span><span class="tok-p">)</span>
   <span class="tok-n">player2</span><span class="tok-o">=</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">player2&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">player&quot;</span><span class="tok-p">)</span>

   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span><span class="tok-p">,</span> <span class="tok-n">player2</span> <span class="tok-p">},</span> <span class="tok-n">player1</span> <span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T1</span><span class="tok-p">,</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span><span class="tok-o">+</span><span class="tok-n">duration</span><span class="tok-p">)</span>

   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">ACTIVE&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Active_T1Expired</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span> <span class="tok-p">},</span> <span class="tok-n">player1</span> <span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span> <span class="tok-p">},</span> <span class="tok-n">player2</span> <span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">ACTIVE&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T1_EXPIRED&quot;</span><span class="tok-p">,</span><span class="tok-n">Active_T1Expired</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../examples/pingpong/player.png" alt="player">
</div>
<div class="title">Figure 3. Player agent</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Agent script: player.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">interval</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
<span class="tok-kd">local</span> <span class="tok-n">T</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">timer</span><span class="tok-p">(</span><span class="tok-n">interval</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T_EXPIRED&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">local</span> <span class="tok-n">peer</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">PrintSignal</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: Received %s from %u&quot;</span><span class="tok-p">,</span><span class="tok-n">name_</span><span class="tok-p">,</span><span class="tok-n">signame_</span><span class="tok-p">,</span><span class="tok-n">sender_</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Init</span><span class="tok-p">(</span><span class="tok-n">ping_interval</span><span class="tok-p">)</span>
   <span class="tok-n">interval</span> <span class="tok-o">=</span> <span class="tok-n">ping_interval</span> <span class="tok-ow">or</span> <span class="tok-n">interval</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Waiting_Start</span><span class="tok-p">()</span>
   <span class="tok-n">PrintSignal</span><span class="tok-p">()</span>
   <span class="tok-n">peer</span> <span class="tok-o">=</span> <span class="tok-n">signal_</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T</span><span class="tok-p">,</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span><span class="tok-o">+</span><span class="tok-n">interval</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Initiator&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Initiator_TExpired</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">PING&quot;</span><span class="tok-p">,</span> <span class="tok-n">self_</span> <span class="tok-p">},</span> <span class="tok-n">peer</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T</span><span class="tok-p">,</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span><span class="tok-o">+</span><span class="tok-n">interval</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Initiator_Pong</span><span class="tok-p">()</span>
   <span class="tok-n">PrintSignal</span><span class="tok-p">()</span>
<span class="tok-k">end</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Waiting_Ping</span><span class="tok-p">()</span>
   <span class="tok-n">PrintSignal</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">PONG&quot;</span><span class="tok-p">,</span> <span class="tok-n">self_</span> <span class="tok-p">},</span> <span class="tok-n">signal_</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">])</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Responder&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-kd">local</span> <span class="tok-n">Responder_Ping</span> <span class="tok-o">=</span> <span class="tok-n">Waiting_Ping</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Any_Stop</span><span class="tok-p">()</span>
   <span class="tok-n">PrintSignal</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
<span class="tok-k">end</span>


<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Init</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span><span class="tok-p">,</span> <span class="tok-n">Waiting_Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">PING&quot;</span><span class="tok-p">,</span> <span class="tok-n">Waiting_Ping</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Initiator&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">T_EXPIRED&quot;</span><span class="tok-p">,</span> <span class="tok-n">Initiator_TExpired</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Initiator&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">PONG&quot;</span><span class="tok-p">,</span> <span class="tok-n">Initiator_Pong</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Responder&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">PING&quot;</span><span class="tok-p">,</span> <span class="tok-n">Responder_Ping</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Any&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span><span class="tok-p">,</span> <span class="tok-n">Any_Stop</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">default</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Any&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ping_pong_over_udp">Ping Pong over UDP</h3>
<div class="paragraph">
<p>This example reuses the <code>player.lua</code> script from the <a href="#_ping_pong">Ping Pong</a> example.</p>
</div>
<div class="paragraph">
<p>This time the two player agents exchanging pings and pongs are created in two different
systems - i.e. two different OS processes - and communicate over UDP. The system agent
of each side translates messages received on the socket into signals to be forwarded to
the local player agent, and viceversa.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/udppingpong/</code>. To run the example
there are two shell scripts, <code>responder</code> and <code>initiator</code>, to be executed in this order
in two different shells.</p>
</div>
<div class="paragraph">
<p>Please notice how the shell scripts define the <code>LUNASDL_PATH</code> environment variable so that
LunaSDL can find the <code>player.lua</code> script in the directory containing the previous example
(this is needed in this example because the script is not in the current directory).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>
<span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">port</span> <span class="tok-o">=</span> <span class="tok-nb">tonumber</span><span class="tok-p">(({</span><span class="tok-o">...</span><span class="tok-p">})[</span><span class="tok-mi">1</span><span class="tok-p">])</span> <span class="tok-ow">or</span> <span class="tok-mi">8080</span>
<span class="tok-kd">local</span> <span class="tok-n">duration</span> <span class="tok-o">=</span> <span class="tok-nb">tonumber</span><span class="tok-p">(({</span><span class="tok-o">...</span><span class="tok-p">})[</span><span class="tok-mi">2</span><span class="tok-p">])</span> <span class="tok-ow">or</span> <span class="tok-mi">10</span> <span class="tok-c1">-- seconds</span>
<span class="tok-kd">local</span> <span class="tok-n">interval</span> <span class="tok-o">=</span> <span class="tok-nb">tonumber</span><span class="tok-p">(({</span><span class="tok-o">...</span><span class="tok-p">})[</span><span class="tok-mi">3</span><span class="tok-p">])</span> <span class="tok-c1">-- (or nil) seconds</span>

<span class="tok-kd">local</span> <span class="tok-n">role</span> <span class="tok-o">=</span> <span class="tok-n">interval</span> <span class="tok-ow">and</span> <span class="tok-s2">&quot;</span><span class="tok-s">initiator&quot;</span> <span class="tok-ow">or</span> <span class="tok-s2">&quot;</span><span class="tok-s">responder&quot;</span>

<span class="tok-kd">local</span> <span class="tok-n">ip</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;</span><span class="tok-s">127.0.0.1&quot;</span>
<span class="tok-kd">local</span> <span class="tok-n">remip</span> <span class="tok-o">=</span> <span class="tok-n">ip</span>
<span class="tok-kd">local</span> <span class="tok-n">remport</span> <span class="tok-o">=</span> <span class="tok-n">port</span><span class="tok-o">+</span><span class="tok-mi">1</span>

<span class="tok-k">if</span> <span class="tok-n">role</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">initiator&quot;</span> <span class="tok-k">then</span> <span class="tok-c1">--swap UDP address</span>
   <span class="tok-n">port</span><span class="tok-p">,</span> <span class="tok-n">remport</span> <span class="tok-o">=</span> <span class="tok-n">remport</span><span class="tok-p">,</span> <span class="tok-n">port</span>
   <span class="tok-n">ip</span><span class="tok-p">,</span> <span class="tok-n">remip</span> <span class="tok-o">=</span> <span class="tok-n">remip</span><span class="tok-p">,</span> <span class="tok-n">ip</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logopen</span><span class="tok-p">(</span><span class="tok-nb">string.format</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s.log&quot;</span><span class="tok-p">,</span><span class="tok-n">role</span><span class="tok-p">))</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">traceson</span><span class="tok-p">()</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">,</span><span class="tok-n">ip</span><span class="tok-p">,</span><span class="tok-n">port</span><span class="tok-p">,</span><span class="tok-n">remip</span><span class="tok-p">,</span><span class="tok-n">remport</span><span class="tok-p">,</span><span class="tok-n">duration</span><span class="tok-p">,</span><span class="tok-n">interval</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../examples/udppingpong/system.png" alt="system">
</div>
<div class="title">Figure 4. System agent</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- System agent script: system.lua</span>

<span class="tok-n">socket</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">socket&quot;</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">T1</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">timer</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T1&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">local</span> <span class="tok-n">player</span>
<span class="tok-kd">local</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-n">peerip</span><span class="tok-p">,</span> <span class="tok-n">peerport</span><span class="tok-p">,</span> <span class="tok-n">role</span>


<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">udprecv</span><span class="tok-p">()</span> <span class="tok-c1">-- socket &#39;read&#39; callback</span>
   <span class="tok-c1">-- get the UDP datagram and the sender&#39;s address</span>
   <span class="tok-kd">local</span> <span class="tok-n">msg</span><span class="tok-p">,</span> <span class="tok-n">fromip</span><span class="tok-p">,</span> <span class="tok-n">fromport</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">:</span><span class="tok-n">receivefrom</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">received &#39;%s&#39; from %s:%s&quot;</span><span class="tok-p">,</span><span class="tok-n">msg</span><span class="tok-p">,</span><span class="tok-n">fromip</span><span class="tok-p">,</span><span class="tok-n">fromport</span><span class="tok-p">)</span>

   <span class="tok-c1">-- check that it is an expected message</span>
   <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">msg</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">PING&quot;</span> <span class="tok-ow">or</span> <span class="tok-n">msg</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">PONG&quot;</span> <span class="tok-ow">or</span> <span class="tok-n">msg</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span><span class="tok-p">)</span>

   <span class="tok-c1">-- send the corresponding signal to the local player agent</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-n">msg</span><span class="tok-p">,</span> <span class="tok-n">self_</span> <span class="tok-p">},</span> <span class="tok-n">player</span><span class="tok-p">)</span>
   <span class="tok-k">if</span> <span class="tok-n">msg</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span> <span class="tok-k">then</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
   <span class="tok-k">end</span>
<span class="tok-k">end</span>


<span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">(</span><span class="tok-n">ip</span><span class="tok-p">,</span> <span class="tok-n">port</span><span class="tok-p">,</span> <span class="tok-n">remip</span><span class="tok-p">,</span> <span class="tok-n">remport</span><span class="tok-p">,</span> <span class="tok-n">duration</span><span class="tok-p">,</span> <span class="tok-n">ping_interval</span><span class="tok-p">)</span>
   <span class="tok-n">peerip</span> <span class="tok-o">=</span> <span class="tok-n">remip</span>
   <span class="tok-n">peerport</span> <span class="tok-o">=</span> <span class="tok-n">remport</span>
   <span class="tok-n">role</span> <span class="tok-o">=</span> <span class="tok-n">ping_interval</span> <span class="tok-ow">and</span> <span class="tok-s2">&quot;</span><span class="tok-s">initiator&quot;</span> <span class="tok-ow">or</span> <span class="tok-s2">&quot;</span><span class="tok-s">responder&quot;</span>

   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">starting %s at %s:%s (peer system is at %s:%s)&quot;</span><span class="tok-p">,</span>
         <span class="tok-n">role</span><span class="tok-p">,</span><span class="tok-n">ip</span><span class="tok-p">,</span><span class="tok-n">port</span><span class="tok-p">,</span><span class="tok-n">peerip</span><span class="tok-p">,</span><span class="tok-n">peerport</span><span class="tok-p">)</span>

   <span class="tok-c1">-- create a UDP socket and bind it to ip:port</span>
   <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">socket</span><span class="tok-p">.</span><span class="tok-n">udp</span><span class="tok-p">())</span>
   <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">:</span><span class="tok-n">setsockname</span><span class="tok-p">(</span><span class="tok-n">ip</span><span class="tok-p">,</span><span class="tok-n">port</span><span class="tok-p">))</span>
   <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">:</span><span class="tok-n">setoption</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">reuseaddr&quot;</span><span class="tok-p">,</span><span class="tok-kc">true</span><span class="tok-p">))</span>

   <span class="tok-c1">-- register the socket in the event loop</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">register</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-n">udprecv</span><span class="tok-p">)</span>

   <span class="tok-c1">-- create the player agent</span>
   <span class="tok-n">player</span><span class="tok-o">=</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">player&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">pingpong.player&quot;</span><span class="tok-p">,</span> <span class="tok-n">ping_interval</span><span class="tok-p">)</span> <span class="tok-c1">--</span>

   <span class="tok-c1">-- send it the start signal (initiator side only)</span>
   <span class="tok-k">if</span> <span class="tok-n">role</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">initiator&quot;</span> <span class="tok-k">then</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span><span class="tok-p">,</span> <span class="tok-n">self_</span> <span class="tok-p">},</span> <span class="tok-n">player</span> <span class="tok-p">)</span>
   <span class="tok-k">end</span>

   <span class="tok-c1">-- start the overall timer</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T1</span><span class="tok-p">,</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span><span class="tok-o">+</span><span class="tok-n">duration</span><span class="tok-p">)</span>

   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>


<span class="tok-k">function</span> <span class="tok-nf">Active_T1Expired</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span> <span class="tok-p">},</span> <span class="tok-n">player</span> <span class="tok-p">)</span>
   <span class="tok-n">s</span><span class="tok-p">:</span><span class="tok-n">sendto</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span><span class="tok-p">,</span><span class="tok-n">peerip</span><span class="tok-p">,</span><span class="tok-n">peerport</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">(</span><span class="tok-k">function</span> <span class="tok-p">()</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">deregister</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">)</span> <span class="tok-n">s</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span> <span class="tok-k">end</span><span class="tok-p">)</span>
<span class="tok-k">end</span>


<span class="tok-k">function</span> <span class="tok-nf">Active_Any</span><span class="tok-p">()</span>
   <span class="tok-c1">-- signal from local player, redirect signal name to peer system</span>
   <span class="tok-n">s</span><span class="tok-p">:</span><span class="tok-n">sendto</span><span class="tok-p">(</span><span class="tok-n">signame_</span><span class="tok-p">,</span><span class="tok-n">peerip</span><span class="tok-p">,</span><span class="tok-n">peerport</span><span class="tok-p">)</span>
<span class="tok-k">end</span>


<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T1&quot;</span><span class="tok-p">,</span><span class="tok-n">Active_T1Expired</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">*&quot;</span><span class="tok-p">,</span><span class="tok-n">Active_Any</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"># Responder shell script
export LUNASDL_PATH=&quot;../?.lua;;&quot;
lua main.lua 8090 20 # port duration</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"># Initiator shell script
export LUNASDL_PATH=&quot;../?.lua;;&quot;
lua main.lua 8090 10 1 # responder_port duration ping_interval</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_web_pages_download">Web pages download</h3>
<div class="paragraph">
<p>This example is a LunaSDL version of the Lua coroutines example from chapter 9 of
Roberto Ierusalimschy&#8217;s <a href="http://www.lua.org/pil/">"Programming in Lua"</a> (a must-read).</p>
</div>
<div class="paragraph">
<p>The <code>download.lua</code> agent script defines an agent that connects to the HTTP port of
an host and downloads a file. The system agent creates four such agents - one for
each desired web page - which <em>concurrently</em> download the files.</p>
</div>
<div class="paragraph">
<p>As in the PIL example, the files are not saved anywhere and the application just
counts the downloaded bytes.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/webdownload/</code>. Run the example
with&#8230;&#8203; well.. you&#8217;ll figure out.</p>
</div>
<div class="paragraph">
<p><em>(No fancy diagrams here. They would not be very interesting.)</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">host</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;</span><span class="tok-s">www.w3.org&quot;</span> <span class="tok-c1">-- web site where to download the pages</span>

<span class="tok-kd">local</span> <span class="tok-n">pages</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-c1">-- list of desired pages</span>
 <span class="tok-s2">&quot;</span><span class="tok-s">/TR/html401/html40.txt&quot;</span><span class="tok-p">,</span>
 <span class="tok-s2">&quot;</span><span class="tok-s">/TR/2002/REC-xhtml1-20020801/xhtml1.pdf&quot;</span><span class="tok-p">,</span>
 <span class="tok-s2">&quot;</span><span class="tok-s">/TR/REC-html32.html&quot;</span><span class="tok-p">,</span>
 <span class="tok-s2">&quot;</span><span class="tok-s">/TR/2000/REC-DOM-Level-2-Core-20001113/DOM2-Core.txt&quot;</span>
<span class="tok-p">}</span>

<span class="tok-c1">--sdl.logopen(&quot;example.log&quot;)</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-kc">nil</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">,</span> <span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">pages</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- System agent: system.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">ts</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-k">function</span> <span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">pages</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: Creating agents&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">)</span>
   <span class="tok-k">for</span> <span class="tok-n">_</span><span class="tok-p">,</span><span class="tok-n">file</span> <span class="tok-k">in</span> <span class="tok-nb">ipairs</span><span class="tok-p">(</span><span class="tok-n">pages</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-kc">nil</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">download&quot;</span><span class="tok-p">,</span> <span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-p">)</span>
   <span class="tok-k">end</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">(</span><span class="tok-k">function</span> <span class="tok-p">()</span>
         <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: Elapsed %.1f seconds&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">since</span><span class="tok-p">(</span><span class="tok-n">ts</span><span class="tok-p">))</span>
      <span class="tok-k">end</span> <span class="tok-p">)</span>
   <span class="tok-k">end</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Agent script: download.lua</span>

<span class="tok-n">socket</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">socket&quot;</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">nread</span> <span class="tok-o">=</span> <span class="tok-mi">0</span> <span class="tok-c1">-- bytes read</span>
<span class="tok-kd">local</span> <span class="tok-n">bs</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-o">^</span><span class="tok-mi">10</span> <span class="tok-c1">-- block size</span>

<span class="tok-k">function</span> <span class="tok-nf">Callback</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-c1">-- socket &#39;read&#39; callback</span>
   <span class="tok-kd">local</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-n">status</span><span class="tok-p">,</span> <span class="tok-n">partial</span> <span class="tok-o">=</span> <span class="tok-n">c</span><span class="tok-p">:</span><span class="tok-n">receive</span><span class="tok-p">(</span><span class="tok-n">bs</span><span class="tok-p">)</span>
   <span class="tok-k">if</span> <span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;</span><span class="tok-s">closed&quot;</span> <span class="tok-k">then</span>
      <span class="tok-k">if</span> <span class="tok-n">partial</span> <span class="tok-k">then</span> <span class="tok-n">nread</span> <span class="tok-o">=</span> <span class="tok-n">nread</span> <span class="tok-o">+</span> <span class="tok-o">#</span><span class="tok-n">partial</span> <span class="tok-k">end</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">deregister</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span>
      <span class="tok-n">c</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: read %u bytes (finished)&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">nread</span><span class="tok-p">)</span>
      <span class="tok-k">return</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
   <span class="tok-k">end</span>
   <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">s</span> <span class="tok-ow">or</span> <span class="tok-n">partial</span>
   <span class="tok-n">nread</span> <span class="tok-o">=</span> <span class="tok-n">nread</span> <span class="tok-o">+</span> <span class="tok-o">#</span><span class="tok-n">s</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: read %u bytes&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">nread</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-k">function</span> <span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-p">)</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: connecting to %s:80&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">host</span><span class="tok-p">)</span>
      <span class="tok-kd">local</span> <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">socket</span><span class="tok-p">.</span><span class="tok-n">connect</span><span class="tok-p">(</span><span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-mi">80</span><span class="tok-p">))</span>

      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">register</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">Callback</span><span class="tok-p">)</span>

      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: retrieving &#39;%s&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">file</span><span class="tok-p">)</span>
      <span class="tok-n">c</span><span class="tok-p">:</span><span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">GET &quot;</span> <span class="tok-o">..</span> <span class="tok-n">file</span> <span class="tok-o">..</span><span class="tok-s2">&quot;</span><span class="tok-s"> HTTP/1.0</span><span class="tok-se">\r\n\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>

      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">_&quot;</span><span class="tok-p">)</span>
   <span class="tok-k">end</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_database_agent">Database agent</h3>
<div class="paragraph">
<p>This example uses the <a href="#_remote_functions">remote functions</a> construct to implement
a centralized database agent that serves other user agents.</p>
</div>
<div class="paragraph">
<p>The <code>database.lua</code> script defines the database agent. The <code>user.lua</code> script
defines a user agent that locates the database by its <a href="#agent_name">agent name</a>
and uses the 'get' and 'set' functions exported by it.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/database/</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-c1">-- get the no. of entries in the database</span>
<span class="tok-kd">local</span> <span class="tok-n">n_entries</span> <span class="tok-o">=</span> <span class="tok-nb">tonumber</span><span class="tok-p">(({</span><span class="tok-o">...</span><span class="tok-p">})[</span><span class="tok-mi">1</span><span class="tok-p">])</span> <span class="tok-ow">or</span> <span class="tok-mi">1000</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logopen</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">example.log&quot;</span><span class="tok-p">)</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-kc">nil</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">,</span> <span class="tok-n">n_entries</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- System agent script: system.lua</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-k">function</span> <span class="tok-p">(</span><span class="tok-n">n_entries</span><span class="tok-p">)</span>
   <span class="tok-c1">-- create the database process</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Database&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">database&quot;</span><span class="tok-p">,</span><span class="tok-n">n_entries</span><span class="tok-p">)</span>

   <span class="tok-c1">-- create the user process and send it a START signal</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">User&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">user&quot;</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span> <span class="tok-p">},</span> <span class="tok-n">offspring_</span><span class="tok-p">)</span>

   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
<span class="tok-k">end</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Agent script: database.lua (database process)</span>

<span class="tok-kd">local</span> <span class="tok-n">database</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>

<span class="tok-k">function</span> <span class="tok-nf">set</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span><span class="tok-n">val</span><span class="tok-p">)</span> <span class="tok-c1">-- &#39;set&#39; method</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: set(%u)=&#39;%s&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">val</span><span class="tok-p">)</span>
   <span class="tok-n">database</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-o">=</span><span class="tok-n">val</span>
   <span class="tok-k">return</span> <span class="tok-n">database</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">)</span> <span class="tok-c1">-- &#39;get&#39; method</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: get(%u)=&#39;%s&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">database</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">])</span>
   <span class="tok-k">return</span> <span class="tok-n">database</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-k">function</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
   <span class="tok-c1">-- populate the database</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: populating database with %u entries&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">n</span><span class="tok-p">)</span>
   <span class="tok-k">for</span> <span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-n">n</span> <span class="tok-k">do</span>
      <span class="tok-n">database</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nb">string.format</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">entry no %u&quot;</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-p">);</span>
   <span class="tok-k">end</span>

   <span class="tok-c1">-- export the get/set functions for remote calls</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">exportfunc</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">set&quot;</span><span class="tok-p">,</span><span class="tok-n">set</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">exportfunc</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">get&quot;</span><span class="tok-p">,</span><span class="tok-n">get</span><span class="tok-p">)</span>

   <span class="tok-c1">-- not important in this example</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">_&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Agent script: user.lua (database user)</span>

<span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">()</span>
   <span class="tok-c1">-- find the pid of the agent named &quot;Database&quot; in this block:</span>
   <span class="tok-kd">local</span> <span class="tok-n">database</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">pidof</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Database&quot;</span><span class="tok-p">)</span>
   <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">database</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">cannot find database&quot;</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: Database pid is %u&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">database</span><span class="tok-p">)</span>

   <span class="tok-kd">local</span> <span class="tok-n">ts</span>
   <span class="tok-n">ts</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span>

   <span class="tok-c1">-- get an entry from the database</span>
   <span class="tok-n">ts</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span>
   <span class="tok-kd">local</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">123</span>
   <span class="tok-kd">local</span> <span class="tok-n">val</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">remfunc</span><span class="tok-p">(</span><span class="tok-n">database</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">get&quot;</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-p">)</span>
   <span class="tok-kd">local</span> <span class="tok-n">elapsed</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">since</span><span class="tok-p">(</span><span class="tok-n">ts</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: entry %u is &#39;%s&#39; (retrieved in %.6f s)&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">val</span><span class="tok-p">,</span> <span class="tok-n">elapsed</span><span class="tok-p">)</span>

   <span class="tok-c1">-- overwrite it in the database...</span>
   <span class="tok-n">ts</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">remfunc</span><span class="tok-p">(</span><span class="tok-n">database</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">set&quot;</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-p">,</span><span class="tok-nb">string.format</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">hello %u %u %u&quot;</span><span class="tok-p">,</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">))</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: entry %u set in %.6f s&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">since</span><span class="tok-p">(</span><span class="tok-n">ts</span><span class="tok-p">))</span>

   <span class="tok-c1">-- ... and then get it again</span>
   <span class="tok-n">ts</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span>
   <span class="tok-n">val</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">remfunc</span><span class="tok-p">(</span><span class="tok-n">database</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">get&quot;</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-p">)</span>
   <span class="tok-n">elapsed</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">since</span><span class="tok-p">(</span><span class="tok-n">ts</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: entry %u is &#39;%s&#39; (retrieved in %.6f s)&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">val</span><span class="tok-p">,</span> <span class="tok-n">elapsed</span><span class="tok-p">)</span>

   <span class="tok-c1">-- exit the LunaSDL application</span>
   <span class="tok-nb">os.exit</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">,</span><span class="tok-kc">true</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-k">function</span> <span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>  <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Idle&quot;</span><span class="tok-p">)</span> <span class="tok-k">end</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Idle&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span><span class="tok-p">,</span><span class="tok-n">Start</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_priority_signals">Priority signals</h3>
<div class="paragraph">
<p>This example uses priority signals. The main script
<a href="#sdl.prioritylevels">configures the number of priority levels</a> to 3
(LunaSDL by default has only 1 level of priority, plus the <em>no priority</em> level),
and then creates the system agent, which sends a few signals with different
priorities to itself. Just to see their order of arrival.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/priority/</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>
<span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logopen</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">example.log&quot;</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">traceson</span><span class="tok-p">()</span>

<span class="tok-c1">-- set the number of priority levels:</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">prioritylevels</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-kc">nil</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- System agent: system.lua</span>

<span class="tok-kd">local</span> <span class="tok-k">function</span> <span class="tok-nf">Send</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-c1">-- if n=nil, self-sends a signal named &#39;NORMAL&#39; without priority</span>
<span class="tok-c1">-- otherwise self-sends a signal named &#39;LEVELn&#39;, with priority n</span>
   <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">n</span> <span class="tok-k">then</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-nb">string.format</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">NORMAL&quot;</span><span class="tok-p">)</span> <span class="tok-p">},</span> <span class="tok-n">self_</span><span class="tok-p">)</span>
   <span class="tok-k">else</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-nb">string.format</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">LEVEL%u&quot;</span><span class="tok-p">,</span><span class="tok-n">n</span><span class="tok-p">)</span> <span class="tok-p">},</span> <span class="tok-n">self_</span><span class="tok-p">,</span> <span class="tok-n">n</span><span class="tok-p">)</span>
   <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">()</span>
   <span class="tok-c1">-- send a few signal with different priorities to self</span>

   <span class="tok-c1">-- this has no priority (i.e. lower than lowest priority):</span>
   <span class="tok-n">Send</span><span class="tok-p">()</span>

   <span class="tok-c1">-- these also have no priority because their level is higher</span>
   <span class="tok-c1">-- than the configured number (=3) of priority levels:</span>
   <span class="tok-n">Send</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span>
   <span class="tok-n">Send</span><span class="tok-p">(</span><span class="tok-mi">4</span><span class="tok-p">)</span>

   <span class="tok-c1">-- these have increasing priorities:</span>
   <span class="tok-n">Send</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-c1">-- lowest (&gt; no priority)</span>
   <span class="tok-n">Send</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-c1">-- medium priority</span>
   <span class="tok-n">Send</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-c1">-- highest (level 1 is always the highest)</span>

   <span class="tok-c1">-- this has priority 1 because the receiver decided so</span>
   <span class="tok-c1">-- by using the sdl.priorityinput function (see below)</span>
   <span class="tok-n">Send</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">)</span>

   <span class="tok-c1">-- finally, this also has no priority, and since signals with</span>
   <span class="tok-c1">-- the same priority are dispatched first-in-first-out, it</span>
   <span class="tok-c1">-- should arrive last:</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span> <span class="tok-p">},</span> <span class="tok-n">self_</span> <span class="tok-p">)</span>

   <span class="tok-c1">-- summarizing, the order of arrival should be the following:</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">expected order of arrival:&quot;</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">LEVEL1, LEVEL6, LEVEL2, LEVEL3, NORMAL, LEVEL5, LEVEL4, STOP&quot;</span><span class="tok-p">)</span>

   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Recvd</span><span class="tok-p">()</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">received %s&quot;</span><span class="tok-p">,</span><span class="tok-n">signame_</span><span class="tok-p">)</span> <span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">*&quot;</span><span class="tok-p">,</span> <span class="tok-n">Recvd</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span><span class="tok-p">,</span> <span class="tok-k">function</span> <span class="tok-p">()</span> <span class="tok-n">Recvd</span><span class="tok-p">()</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span> <span class="tok-k">end</span><span class="tok-p">)</span>

<span class="tok-c1">-- set the priority of &#39;LEVEL6&#39; input signals to 1 (i.e. highest priority):</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">priorityinput</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">LEVEL6&quot;</span><span class="tok-p">,</span><span class="tok-mi">1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_procedure_call">Procedure call</h3>
<div class="paragraph">
<p>This example shows a <a href="#_procedures">procedure call</a> and. It also uses
<a href="#_time_triggered_signals">time-triggered signals</a>.</p>
</div>
<div class="paragraph">
<p>The system agent creates a <em>caller agent</em> with the <code>caller.lua</code> script and then sends
some signals to it. The caller agent calls the procedure defined in the <code>procedure.lua</code>
script. While the procedure is executing, all signals sent to the caller agent by the system agent
are redirected to the procedure, which <a href="#sdl.save">saves</a> them.
When the procedure returns, all the signals saved by it are automatically moved in the caller
agent&#8217;s <em>saved queue</em>. The caller <a href="#sdl.restore">restores</a> and receives them, and then it
receives other signals newly sent to it by the system agent.</p>
</div>
<div class="paragraph">
<p>The scripts for this example are in <code>examples/procedure/</code>.</p>
</div>
<div class="paragraph">
<p><em>(The lyrics in the code are from a catchy song by Matt Bianco and Basia.)</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Main script: main.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">sdl</span> <span class="tok-o">=</span> <span class="tok-nb">require</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">lunasdl&quot;</span><span class="tok-p">)</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">logopen</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">example.log&quot;</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">traceson</span><span class="tok-p">()</span>

<span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">createsystem</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">System&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">system&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- System agent script: system.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">caller</span> <span class="tok-c1">-- caller agent&#39;s pid</span>
<span class="tok-kd">local</span> <span class="tok-n">T1</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">timer</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T1&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">local</span> <span class="tok-n">cnt</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-kd">local</span> <span class="tok-n">lyrics</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">Softly glowing, watch the river flowing&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">It&#39;s reflections shine into my eyes&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">I see clearer when you hold the mirror&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">And can reach the stars up in the sky tonight&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">(Under the moonlight, dancing in the moonlight)&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">All around the universe, you&#39;re looking down&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">I know you&#39;re watching over me&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">La Luna, is it a mild case of madness?&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">(Under the moonlight, underneath the moonlight)&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">La Luna, you take me out of the darkness&quot;</span><span class="tok-p">,</span>
   <span class="tok-s2">&quot;</span><span class="tok-s">(Under the moonlight, dancing in the moonlight)&quot;</span>
<span class="tok-p">}</span>

<span class="tok-k">function</span> <span class="tok-nf">Active_T1</span><span class="tok-p">()</span>
   <span class="tok-n">cnt</span> <span class="tok-o">=</span> <span class="tok-n">cnt</span><span class="tok-o">+</span><span class="tok-mi">1</span>
   <span class="tok-kd">local</span> <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-n">lyrics</span><span class="tok-p">[</span><span class="tok-n">cnt</span><span class="tok-p">]</span>
   <span class="tok-k">if</span> <span class="tok-n">v</span> <span class="tok-k">then</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">VERSE&quot;</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-p">},</span> <span class="tok-n">caller</span><span class="tok-p">)</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T1</span><span class="tok-p">)</span>
   <span class="tok-k">else</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">sendat</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span> <span class="tok-p">},</span> <span class="tok-n">caller</span><span class="tok-p">,</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: stopping&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">)</span>
      <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
   <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Start</span><span class="tok-p">()</span>
   <span class="tok-n">caller</span> <span class="tok-o">=</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Caller&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">caller&quot;</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">send</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span> <span class="tok-p">},</span> <span class="tok-n">caller</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">set</span><span class="tok-p">(</span><span class="tok-n">T1</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>


<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">T1&quot;</span><span class="tok-p">,</span><span class="tok-n">Active_T1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Agent script: caller.lua</span>

<span class="tok-k">function</span> <span class="tok-nf">AtReturn</span><span class="tok-p">(</span><span class="tok-o">...</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">AtReturn(%s)&quot;</span><span class="tok-p">,</span><span class="tok-nb">table.concat</span><span class="tok-p">({</span><span class="tok-o">...</span><span class="tok-p">},</span><span class="tok-s2">&quot;</span><span class="tok-s">,&quot;</span><span class="tok-p">))</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">restore</span><span class="tok-p">()</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Active_Start</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: received %s&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">signame_</span><span class="tok-p">)</span>
   <span class="tok-c1">-- call the procedure, passing it some parameters</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">procedure</span><span class="tok-p">(</span><span class="tok-n">AtReturn</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">Procedure&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">procedure&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;</span><span class="tok-s">hello&quot;</span><span class="tok-p">,</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Active_Stop</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: received %s&quot;</span><span class="tok-p">,</span> <span class="tok-n">name_</span><span class="tok-p">,</span> <span class="tok-n">signame_</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">stop</span><span class="tok-p">()</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Received</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: received &#39;%s&#39; from %u&quot;</span><span class="tok-p">,</span><span class="tok-n">name_</span><span class="tok-p">,</span><span class="tok-n">signal_</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span><span class="tok-n">sender_</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Init</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Init</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">START&quot;</span><span class="tok-p">,</span><span class="tok-n">Active_Start</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">STOP&quot;</span><span class="tok-p">,</span><span class="tok-n">Active_Stop</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Active&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">*&quot;</span><span class="tok-p">,</span> <span class="tok-n">Received</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span class="tok-c1">-- Procedure script: procedure.lua</span>

<span class="tok-kd">local</span> <span class="tok-n">cnt</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-k">function</span> <span class="tok-nf">Waiting_Any</span><span class="tok-p">()</span>
   <span class="tok-c1">-- notice that sender_ is not self_ but caller_</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: received &#39;%s&#39; from %u&quot;</span><span class="tok-p">,</span><span class="tok-n">name_</span><span class="tok-p">,</span><span class="tok-n">signal_</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span><span class="tok-n">sender_</span><span class="tok-p">)</span>
   <span class="tok-n">cnt</span> <span class="tok-o">=</span> <span class="tok-n">cnt</span> <span class="tok-o">+</span><span class="tok-mi">1</span>
   <span class="tok-c1">-- save the signal for the caller:</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
<span class="tok-k">end</span>

<span class="tok-k">function</span> <span class="tok-nf">Waiting_Return</span><span class="tok-p">()</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: received %s from %u&quot;</span><span class="tok-p">,</span><span class="tok-n">name_</span><span class="tok-p">,</span><span class="tok-n">signame_</span><span class="tok-p">,</span><span class="tok-n">sender_</span><span class="tok-p">)</span>
   <span class="tok-c1">-- return from procedure, with return values:</span>
   <span class="tok-k">return</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">procreturn</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">received verses&quot;</span><span class="tok-p">,</span><span class="tok-n">cnt</span><span class="tok-p">)</span>
   <span class="tok-c1">-- no code after sdl.procreturn()</span>
<span class="tok-k">end</span>


<span class="tok-k">function</span> <span class="tok-nf">Init</span><span class="tok-p">(</span><span class="tok-o">...</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">%s: Init(%s)&quot;</span><span class="tok-p">,</span><span class="tok-n">name_</span><span class="tok-p">,</span><span class="tok-nb">table.concat</span><span class="tok-p">({</span><span class="tok-o">...</span><span class="tok-p">},</span><span class="tok-s2">&quot;</span><span class="tok-s">,&quot;</span><span class="tok-p">))</span>
   <span class="tok-c1">-- time-triggered signals are handy in procedures because procedures</span>
   <span class="tok-c1">-- can not create timers...</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">sendat</span><span class="tok-p">({</span> <span class="tok-s2">&quot;</span><span class="tok-s">RETURN&quot;</span> <span class="tok-p">},</span> <span class="tok-n">self_</span><span class="tok-p">,</span> <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">now</span><span class="tok-p">()</span> <span class="tok-o">+</span> <span class="tok-mi">5</span><span class="tok-p">)</span>
   <span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">nextstate</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>


<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">Init</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">RETURN&quot;</span><span class="tok-p">,</span><span class="tok-n">Waiting_Return</span><span class="tok-p">)</span>
<span class="tok-n">sdl</span><span class="tok-p">.</span><span class="tok-n">transition</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-s">Waiting&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;</span><span class="tok-s">*&quot;</span><span class="tok-p">,</span><span class="tok-n">Waiting_Any</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_special_variables">Special variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In LunaSDL applications, identifiers composed of one or more lower-case letters
and ending with an underscore (e.g., <em>self_</em>) are <strong>reserved for special variables</strong>
managed by the LunaSDL module, and should not be used in agents' scripts code.</p>
</div>
<div class="paragraph">
<p>The special (global) variables listed below are always set, and are properly updated
every time (and before) a transition is executed.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>self_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the <a href="#pid">pid</a> of the agent itself.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>name_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the name of the agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>block_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the pid of the SDL block the agent is contained in.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>parent_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the pid of the parent agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>offspring_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the pid of the last child agent created by this one (or <em>nil</em> if none).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>state_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current <a href="#_agent_scripts">state name</a> (or <em>nil</em> if the agent is stopping).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>signal_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the current input <a href="#_signals">signal</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>signame_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the name of the input signal (same as <em>signal_[1]</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>sender_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the sender of the input signal (pid, or tid if the signal is timer-generated).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>caller_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the pid of the original caller of the <a href="#_procedures">procedure</a> (<em>nil</em>,
if the current agent is not a procedure).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>istimer_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a boolean indicating if the input signal was generated by a <a href="#_timers">timer</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>sendtime_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a <a href="#_system_time">timestamp</a> indicating when the signal was sent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>recvtime_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a timestamp indicating when the signal was received.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>exptime_</em></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a timestamp indicating when the signal becomes stale.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All the above variables are to be considered <strong>read-only</strong> (care should be taken not
to change their values from agent script code).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <strong><em>sendtime_</em></strong> timestamp refers actually to the point in time the
signal was scheduled for dispatching. If the signal was sent with <em>sdl.send</em>, this
corresponds to when the function was called; for timer-generated signals, it is the point
in time the timer expiry was detected; for time-triggered signals it is the point in time
the signal was actually delivered.
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_summary_of_lunasdl_functions">Summary of LunaSDL functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The tables below summarize the functions provided by LunaSDL.</p>
</div>
<div class="paragraph">
<p>With some exceptions pointed out in the manual sections, the behavior of all the
functions when an error occurs is to call Lua&#8217;s
<a href="http://www.lua.org/manual/5.3/manual.html#pdf-error"><em>error</em></a> function with a string message.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Create functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.createsystem"><strong>sdl.createsystem</strong></a> ( <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>true</em>, <em>returnvalues</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates the <em>system agent</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.createblock"><strong>sdl.createblock</strong></a> ( <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>pid</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates an agent of the kind <em>block</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.create"><strong>sdl.create</strong></a> ( <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>pid</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates an agent of the kind <em>process</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.systemreturn"><strong>sdl.systemreturn</strong></a> ( <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the system agent return values.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. State transition functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.start"><strong>sdl.start</strong></a> ( <em>func</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the agent&#8217;s <em>start transition</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.transition"><strong>sdl.transition</strong></a> ( <em>state</em>, <em>signame</em>, <em>func</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a transition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.default"><strong>sdl.default</strong></a> ( <em>state</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the agent&#8217;s default state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.nextstate"><strong>sdl.nextstate</strong></a> ( <em>state</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Changes the agent&#8217;s state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.stop"><strong>sdl.stop</strong></a> ( [ <em>atstopfunc</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stops the agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.kill"><strong>sdl.kill</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kills an agent and all its descendants.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Signals functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.send"><strong>sdl.send</strong></a> ( <em>signal</em>, <em>dstpid</em> [, <em>priority</em> ])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>now</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sends a signal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.priorityinput"><strong>sdl.priorityinput</strong></a> ( <em>signame</em>, [ <em>priority</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the priority for an input signal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.sendat"><strong>sdl.sendat</strong></a> ( <em>signal</em>, <em>dstpid</em>, <em>at</em> [, <em>maxdelay</em> ])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sends a time-triggered signal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.save"><strong>sdl.save</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saves the current input signal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.restore"><strong>sdl.restore</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Re-schedules the saved signals.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Timers functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.timer"><strong>sdl.timer</strong></a> ( <em>duration</em>, <em>signame</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>tid</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates a timer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.modify"><strong>sdl.modify</strong></a> ( <em>tid</em>, <em>duration</em> [, <em>signame</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modifies a timer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.set"><strong>sdl.set</strong></a> ( <em>tid</em> [, <em>at</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>now</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets (starts) a timer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.reset"><strong>sdl.reset</strong></a> ( <em>tid</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>now</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resets (stops) a timer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.active"><strong>sdl.active</strong></a> ( <em>tid</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>isactive</em>, <em>at</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the status of a timer.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. System time functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.now"><strong>sdl.now</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>timestamp</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the current system time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.since"><strong>sdl.since</strong></a> ( <em>timestamp</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>timedifference</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the time elapsed since a point in time in the past.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.startingtime"><strong>sdl.startingtime</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>startingtime</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns an absolute timestamp corresponding to system time = <em>0</em>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Agent information functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.pidof"><strong>sdl.pidof</strong></a> ( <em>name</em> [, <em>block</em> ])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>pid</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Searches for an agent by its name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.nameof"><strong>sdl.nameof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>name</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the name of an agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.blockof"><strong>sdl.blockof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>block</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the pid of an agent&#8217;s block.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.parentof"><strong>sdl.parentof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ppid</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the pid of an agent&#8217;s parent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.kindof"><strong>sdl.kindof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>kind</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the SDL <em>kind</em> of an agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.stateof"><strong>sdl.stateof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>state</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the current state of an agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.childrenof"><strong>sdl.childrenof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>childrenlist</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the pids of an agent&#8217;s children.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.timersof"><strong>sdl.timersof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>timerslist</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the tids of an agent&#8217;s timers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.treeof"><strong>sdl.treeof</strong></a> ( [ <em>pid</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>treestring</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns a description of the sub-tree of an agent.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. SDL procedure functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.procedure"><strong>sdl.procedure</strong></a> (<em>atreturn</em>, <em>name</em> , <em>script</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>pid</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes an SDL procedure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.procreturn"><strong>sdl.procreturn</strong></a> ( <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns from a procedure.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Remote functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.exportfunc"><strong>sdl.exportfunc</strong></a> ( <em>funcname</em>, [ <em>func</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exports or revokes a function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.remfunc"><strong>sdl.remfunc</strong></a> ( <em>pid</em>, <em>funcname</em>, <em>&#8230;&#8203;</em> )<br></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>returnvalues</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes a remote function.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. Socket registration</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.register"><strong>sdl.register</strong></a> ( <em>object</em>, <em>readcallback</em> [, <em>writecallback</em> ])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers a file descriptor in the event loop.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.deregister"><strong>sdl.deregister</strong></a> ( <em>object</em> [, <em>mode</em> ])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deregisters a file descriptor from the event loop.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 10. Log functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logopen"><strong>sdl.logopen</strong></a> ( <em>filename</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>filehandle</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opens the system logfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logfile"><strong>sdl.logfile</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>filehandle</em>, <em>filename</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the system logfile handle and name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logson"><strong>sdl.logson</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables logs in the system logfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logson"><strong>sdl.logsoff</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables logs in the system logfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logflush"><strong>sdl.logflush</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flushes the system logfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logclose"><strong>sdl.logclose</strong></a> ( )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flushes and closes the system logfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.logf"><strong>sdl.logf</strong></a> ( <em>formatstring</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes on the system logfile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.printf"><strong>sdl.printf</strong></a> ( <em>formatstring</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes on the system logfile and on <em>stdout</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.traceson"><strong>sdl.traceson</strong></a> ( <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables traces.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.tracesoff"><strong>sdl.tracesoff</strong></a> ( <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables traces.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.trace"><strong>sdl.trace</strong></a> ( <em>tag</em>, <em>formatstring</em>, <em>&#8230;&#8203;</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes a trace on the system logfile.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 11. Optional configuration functions</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 20%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Return values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.envtemplate"><strong>sdl.envtemplate</strong></a> ( <em>env</em> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the template environment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.pollfuncs"><strong>sdl.pollfuncs</strong></a> ( <em>poll</em> [, <em>add</em> [, <em>del</em> [, <em>reset</em>]]] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the poll function and its helper hooks.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.prioritylevels"><strong>sdl.prioritylevels</strong></a> ( [ <em>levels</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the number of priority levels.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.setwallclock"><strong>sdl.setwallclock</strong></a> ( [ <em>gettimefunc</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the <em>gettime</em> function and resets the wallclock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sdl.traceback"><strong>sdl.traceback</strong></a> ( [ <em>s</em> ] )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the stack traceback in error messages.</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. This manual is written in <a href="http://www.methods.co.nz/asciidoc/">AsciiDoc</a>, rendered with <a href="http://asciidoctor.org/">AsciiDoctor</a> and a CSS from the <a href="https://github.com/asciidoctor/asciidoctor-stylesheet-factory">AsciiDoctor Stylesheet Factory</a>. The PDF version is produced with <a href="https://github.com/asciidoctor/asciidoctor-pdf">AsciiDoctor-Pdf</a>. The SDL diagrams are made with the <a href="http://www.yworks.com/en/products/yfiles/yed/">yED Graph Editor</a> and a custom palette of SDL symbols made with <a href="https://inkscape.org/en/">Inkscape</a>.
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. Introductive papers to SDL, a bit outdated but still very good, can be found in the <a href="http://www.telenor.com/innovation/telektronikk/">Telektronikk journal</a>, <em>Volume 4.2000 "Languages for Telecommunication Applications"</em>, Ed: Rolv Brk.)
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. LunaSDL is to be considered an <em>SDL dialect</em> in that it slightly deviates from the <a href="http://www.itu.int/rec/T-REC-Z/en">SDL standards</a> and has some simplifications: it uses an all-to-all pid-based communication model, with a single signal queue instead of per-agent input queues (although one could argue that the per-agent queues ar just merged but still distinguishable by the destination pid&#8230;&#8203;); it has no explicit definitions of channels and gates; in LunaSDL any agent (not only the system agent) may communicate with the environment; it uses Lua data types and has no built-in support for ADT and ASN.1; it has additional non-SDL constructs like priority outputs, time-triggered signals and remote synchronous functions with immediate return.
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. In SDL, the outside world with respect to a system is called the <em>environment</em>. Not to be confused with the <em>Lua environment</em>.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1<br>
Last updated 2015-02-10 07:42:31 CET
</div>
</div>
</body>
</html>